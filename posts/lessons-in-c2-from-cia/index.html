<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Lessons In C2 From The CIA" /><meta name="author" content="Matt C" /><meta property="og:locale" content="en" /><meta name="description" content="Intro I&#39;ve always wanted to make my own C2 framework but have never really found the inspiration to, until I came across a post from Byt3bl33d3r talking about modernizing the CIA&#39;s C2 framework. This was somehow the first time I had come across a paper regarding Switchblade and Hive and I wanted to try and set up a mock version for myself. A Quick Review Of mTLS Before getting into the gritty details of this, let&#39;s review/introduce mTLS. mTLS stands for mutual authentication TLS. This is often implemented in zero-trust environments so that the client knows the server is who they say they are and vice-versa. Where a server normally only presents its certificate to connecting clients and then completes connections, mTLS adds the extra step of the client presenting their certificate so that the server can then verify them. The CIA developed Switchblade to use mTLS to authenticate beacon requests to the C2 server and send everyone else to a fake cover site. It can be seen in the diagram below taken from the Vault 7 leaks. &lt;p&gt;&lt;/p&gt;&lt;h2 style=&quot;text-align: left;&quot;&gt;How Can We Leverage This?&lt;/h2&gt;&lt;p style=&quot;text-align: left;&quot;&gt;I haven’t seen a FOSS C2 framework specifically utilizing mTLS yet. There have been quite a few using HTTPS and that’s fantastic, but it’s always fun to take things one step further. In an engagement, when an analyst examines unusual traffic from workstations, forwarding those unauthenticated queries from them to something like google.com provides a minor level of credibility. Taking that further, you could even host your operations in the Google cloud so when they examine the IP it shows up as being owned by Google. This provides far more cover then returning a server error and sort of allows one to hide in plain sight.&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;&lt;/p&gt;&lt;h4 style=&quot;text-align: left;&quot;&gt; Now into the details of the project.&lt;/h4&gt;&lt;h4 style=&quot;text-align: left;&quot;&gt;Generating certs &lt;/h4&gt;&lt;p style=&quot;text-align: left;&quot;&gt;It took me a little bit to figure out how to properly generate certs for mTLS that work well with our transparent proxy configuration until I came across this resource. I recommend following along with what they have written as it works flawlessly. Just ensure that your CN name matches up with the server name you’ll be routing to, otherwise you’ll encounter errors.&lt;/p&gt;&lt;h4 style=&quot;text-align: left;&quot;&gt;Nginx conf&lt;/h4&gt;&lt;p&gt;The config for Nginx goes into /etc/nginx/conf.d/ and can be found here. There’s nothing super fancy here, it’s primarily the one leaked from the CIA and it uses an if statement to check the supplied certificates. If it fails, the client is transparently redirected to the cover site. We did add a few lines specifically that nginx documents as needed for facilitating websockets, but that’s it. People familiar with nginx will notice that the websocket upgrade arguments are outside of where they should go according to documentation, but this was how it worked without errors and, while troubleshooting this, I noticed that CIA also had it setup this way.&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;&lt;/p&gt;&lt;h4 style=&quot;text-align: left;&quot;&gt;Back-end server&lt;/h4&gt;&lt;div style=&quot;text-align: left;&quot;&gt;For the server, it started as a Node project that nginx uses in their example documentation for websockets. A client connects and checks in with a simple “hello” and then the server fires off a response. After the client check in, they are appended to an array and logged. This has it’s shortcomings. Only one client seems to be able to stay connected at a time so we need a better solution. Thankfully, Node is super popular and I found someone who was handling multiple websockets very quickly! Find this here.&lt;/div&gt;&lt;h4 style=&quot;text-align: left;&quot;&gt;Client&lt;/h4&gt;&lt;p style=&quot;text-align: left;&quot;&gt;Python makes a fantastic test bed to get this up and running super quickly. Super quick might be a reach because the amount written on websockets and mTLS in Python is very sparse compared to other areas. But we’re getting ahead of ourselves. &lt;/p&gt;&lt;p style=&quot;text-align: left;&quot;&gt;Before this, I should talk about what was tried and what failed. This started with doing web requests through Python to a back-end web server, with nginx routing it based off of certificates supplied or not. Which worked fine, the web requests were all routed correctly and they retrieved the page, but there was a hitch. This isn’t an ideal solution in any way because the HTTP protocol is unidirectional and operates on a request response method. Once data is finished being sent, the connection is closed. Passing commands over GET requests is finicky and not very dynamic.  &lt;/p&gt;&lt;p style=&quot;text-align: left;&quot;&gt;I next turned to sockets. Sockets are fantastic but fall just short of the mark here because, with the nginx configuration, I was able to send HTTP GET requests but was not able to get a socket to communicate back and forth through this transparent proxy.&lt;/p&gt;&lt;p style=&quot;text-align: left;&quot;&gt;What’s the solution? Websockets. Nginx out of the box actually supports these really well and we can even see the CIA implementing the start of one in the example configuration leaked. Websockets big advantage is that they allow for bidirectional communication and they work easily with the transparent proxy.&lt;/p&gt;&lt;p style=&quot;text-align: left;&quot;&gt;Find the code for this here. For my example I smashed two projects together from here and here. The interaction between the client and server looks like this.&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;&lt;/p&gt;&lt;p style=&quot;text-align: left;&quot;&gt;Update: We’ve got an interactive shell now!&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;&lt;/p&gt;&lt;h4 style=&quot;text-align: left;&quot;&gt;Client in alternative languages&lt;/h4&gt;&lt;h4 style=&quot;text-align: left;&quot;&gt;&lt;/h4&gt;&lt;p style=&quot;text-align: left;&quot;&gt;Alongside creating the Python client/server, I also wanted something which could more traditionally be compiled into an executable. We have a few candidates we can look at for this, I’m thinking Go or C#. Both languages are well documented, memory safe, and have very strong built in libraries. Unfortunately, I’m not super familiar with developing apps in either, so this will be an adventure. Expect more on this soon.&lt;/p&gt;&lt;h4 style=&quot;text-align: left;&quot;&gt;Following the CIA’s recommendations&lt;/h4&gt;&lt;p style=&quot;text-align: left;&quot;&gt;Since this is the CIA’s general idea for command and control infrastructure, we might as well follow their recommendations for the implant. The CIA, alongside creating Switchblade, have a number of dos/donts for creating malware so as to avoid attribution and detection. These are great tips in general to make detection more difficult which is important in red team engagements. We’ve got to make sure our beacon traffic can’t be replayed, the traffic is encrypted on the wire, the executable leaves a small footprint and is under 150kb, and that we obfuscate or encrypt any sensitive strings internally. There are others, but this is just a baseline. &lt;/p&gt;&lt;p style=&quot;text-align: left;&quot;&gt;Right off the bat, we’re not going to be able to keep any compiled Python based executable under 1000kb, let alone 150kb, so we’ll have to look at other languages for that. We have ensured though that communication between the beacon and the server is encrypted and it can’t be replayed either. This leaves sensitive strings, which certs could fall under. In my beacon example, I just pass the directory and file to read from. But in a deployable version, you will want to incorporate these into the program. In Python, this is a little tricky as the sslSettings.load_cert_chain takes a cert file, not a variable with the cert as a string. So if you wanted to deploy this, you would need to deploy the cert file alongside - which is honestly an annoying short coming. How big of a deal this is depends on you. In Windows, we can add the certs to the cert chain and go from there, but the point is that we need to drop more than one file to make this work and you’ll be expanding your footprint.&lt;/p&gt;&lt;h2 style=&quot;text-align: left;&quot;&gt;Conclusion&lt;/h2&gt;&lt;p style=&quot;text-align: left;&quot;&gt;This was a pretty challenging project for me personally but I’m happy that I got the bare bones of it working the way I envisioned. I really want to get the PE version of the beacon setup so that I can do a mock red team exercise with a couple of Windows servers, server 2019 DC’s, an ELK Security stack, and good ol’ Windows Defender, but that’s for the future. I think this provides a good base to build off of. If we look at a packet capture of this on the wire, we can see all the transmitted data is encrypted. Additionally, nothing can be replayed to the C2 server.&lt;/p&gt;&lt;h4 style=&quot;text-align: left;&quot;&gt;&lt;/h4&gt;&lt;p style=&quot;text-align: left;&quot;&gt;I’m annoyed that I can’t seem to find a way around dropping multiple certificates on the host, and yeah they can be hidden, but it’s increasing the footprint we leave which increases the risk you have of being discovered. I believe the certificates required is the reason you don’t often see this deployed out of specific circumstances. I hope to continue working on the client/server architecture for this so expect more in the future.&lt;/p&gt;" /><meta property="og:description" content="Intro I&#39;ve always wanted to make my own C2 framework but have never really found the inspiration to, until I came across a post from Byt3bl33d3r talking about modernizing the CIA&#39;s C2 framework. This was somehow the first time I had come across a paper regarding Switchblade and Hive and I wanted to try and set up a mock version for myself. A Quick Review Of mTLS Before getting into the gritty details of this, let&#39;s review/introduce mTLS. mTLS stands for mutual authentication TLS. This is often implemented in zero-trust environments so that the client knows the server is who they say they are and vice-versa. Where a server normally only presents its certificate to connecting clients and then completes connections, mTLS adds the extra step of the client presenting their certificate so that the server can then verify them. The CIA developed Switchblade to use mTLS to authenticate beacon requests to the C2 server and send everyone else to a fake cover site. It can be seen in the diagram below taken from the Vault 7 leaks. &lt;p&gt;&lt;/p&gt;&lt;h2 style=&quot;text-align: left;&quot;&gt;How Can We Leverage This?&lt;/h2&gt;&lt;p style=&quot;text-align: left;&quot;&gt;I haven’t seen a FOSS C2 framework specifically utilizing mTLS yet. There have been quite a few using HTTPS and that’s fantastic, but it’s always fun to take things one step further. In an engagement, when an analyst examines unusual traffic from workstations, forwarding those unauthenticated queries from them to something like google.com provides a minor level of credibility. Taking that further, you could even host your operations in the Google cloud so when they examine the IP it shows up as being owned by Google. This provides far more cover then returning a server error and sort of allows one to hide in plain sight.&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;&lt;/p&gt;&lt;h4 style=&quot;text-align: left;&quot;&gt; Now into the details of the project.&lt;/h4&gt;&lt;h4 style=&quot;text-align: left;&quot;&gt;Generating certs &lt;/h4&gt;&lt;p style=&quot;text-align: left;&quot;&gt;It took me a little bit to figure out how to properly generate certs for mTLS that work well with our transparent proxy configuration until I came across this resource. I recommend following along with what they have written as it works flawlessly. Just ensure that your CN name matches up with the server name you’ll be routing to, otherwise you’ll encounter errors.&lt;/p&gt;&lt;h4 style=&quot;text-align: left;&quot;&gt;Nginx conf&lt;/h4&gt;&lt;p&gt;The config for Nginx goes into /etc/nginx/conf.d/ and can be found here. There’s nothing super fancy here, it’s primarily the one leaked from the CIA and it uses an if statement to check the supplied certificates. If it fails, the client is transparently redirected to the cover site. We did add a few lines specifically that nginx documents as needed for facilitating websockets, but that’s it. People familiar with nginx will notice that the websocket upgrade arguments are outside of where they should go according to documentation, but this was how it worked without errors and, while troubleshooting this, I noticed that CIA also had it setup this way.&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;&lt;/p&gt;&lt;h4 style=&quot;text-align: left;&quot;&gt;Back-end server&lt;/h4&gt;&lt;div style=&quot;text-align: left;&quot;&gt;For the server, it started as a Node project that nginx uses in their example documentation for websockets. A client connects and checks in with a simple “hello” and then the server fires off a response. After the client check in, they are appended to an array and logged. This has it’s shortcomings. Only one client seems to be able to stay connected at a time so we need a better solution. Thankfully, Node is super popular and I found someone who was handling multiple websockets very quickly! Find this here.&lt;/div&gt;&lt;h4 style=&quot;text-align: left;&quot;&gt;Client&lt;/h4&gt;&lt;p style=&quot;text-align: left;&quot;&gt;Python makes a fantastic test bed to get this up and running super quickly. Super quick might be a reach because the amount written on websockets and mTLS in Python is very sparse compared to other areas. But we’re getting ahead of ourselves. &lt;/p&gt;&lt;p style=&quot;text-align: left;&quot;&gt;Before this, I should talk about what was tried and what failed. This started with doing web requests through Python to a back-end web server, with nginx routing it based off of certificates supplied or not. Which worked fine, the web requests were all routed correctly and they retrieved the page, but there was a hitch. This isn’t an ideal solution in any way because the HTTP protocol is unidirectional and operates on a request response method. Once data is finished being sent, the connection is closed. Passing commands over GET requests is finicky and not very dynamic.  &lt;/p&gt;&lt;p style=&quot;text-align: left;&quot;&gt;I next turned to sockets. Sockets are fantastic but fall just short of the mark here because, with the nginx configuration, I was able to send HTTP GET requests but was not able to get a socket to communicate back and forth through this transparent proxy.&lt;/p&gt;&lt;p style=&quot;text-align: left;&quot;&gt;What’s the solution? Websockets. Nginx out of the box actually supports these really well and we can even see the CIA implementing the start of one in the example configuration leaked. Websockets big advantage is that they allow for bidirectional communication and they work easily with the transparent proxy.&lt;/p&gt;&lt;p style=&quot;text-align: left;&quot;&gt;Find the code for this here. For my example I smashed two projects together from here and here. The interaction between the client and server looks like this.&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;&lt;/p&gt;&lt;p style=&quot;text-align: left;&quot;&gt;Update: We’ve got an interactive shell now!&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;&lt;/p&gt;&lt;h4 style=&quot;text-align: left;&quot;&gt;Client in alternative languages&lt;/h4&gt;&lt;h4 style=&quot;text-align: left;&quot;&gt;&lt;/h4&gt;&lt;p style=&quot;text-align: left;&quot;&gt;Alongside creating the Python client/server, I also wanted something which could more traditionally be compiled into an executable. We have a few candidates we can look at for this, I’m thinking Go or C#. Both languages are well documented, memory safe, and have very strong built in libraries. Unfortunately, I’m not super familiar with developing apps in either, so this will be an adventure. Expect more on this soon.&lt;/p&gt;&lt;h4 style=&quot;text-align: left;&quot;&gt;Following the CIA’s recommendations&lt;/h4&gt;&lt;p style=&quot;text-align: left;&quot;&gt;Since this is the CIA’s general idea for command and control infrastructure, we might as well follow their recommendations for the implant. The CIA, alongside creating Switchblade, have a number of dos/donts for creating malware so as to avoid attribution and detection. These are great tips in general to make detection more difficult which is important in red team engagements. We’ve got to make sure our beacon traffic can’t be replayed, the traffic is encrypted on the wire, the executable leaves a small footprint and is under 150kb, and that we obfuscate or encrypt any sensitive strings internally. There are others, but this is just a baseline. &lt;/p&gt;&lt;p style=&quot;text-align: left;&quot;&gt;Right off the bat, we’re not going to be able to keep any compiled Python based executable under 1000kb, let alone 150kb, so we’ll have to look at other languages for that. We have ensured though that communication between the beacon and the server is encrypted and it can’t be replayed either. This leaves sensitive strings, which certs could fall under. In my beacon example, I just pass the directory and file to read from. But in a deployable version, you will want to incorporate these into the program. In Python, this is a little tricky as the sslSettings.load_cert_chain takes a cert file, not a variable with the cert as a string. So if you wanted to deploy this, you would need to deploy the cert file alongside - which is honestly an annoying short coming. How big of a deal this is depends on you. In Windows, we can add the certs to the cert chain and go from there, but the point is that we need to drop more than one file to make this work and you’ll be expanding your footprint.&lt;/p&gt;&lt;h2 style=&quot;text-align: left;&quot;&gt;Conclusion&lt;/h2&gt;&lt;p style=&quot;text-align: left;&quot;&gt;This was a pretty challenging project for me personally but I’m happy that I got the bare bones of it working the way I envisioned. I really want to get the PE version of the beacon setup so that I can do a mock red team exercise with a couple of Windows servers, server 2019 DC’s, an ELK Security stack, and good ol’ Windows Defender, but that’s for the future. I think this provides a good base to build off of. If we look at a packet capture of this on the wire, we can see all the transmitted data is encrypted. Additionally, nothing can be replayed to the C2 server.&lt;/p&gt;&lt;h4 style=&quot;text-align: left;&quot;&gt;&lt;/h4&gt;&lt;p style=&quot;text-align: left;&quot;&gt;I’m annoyed that I can’t seem to find a way around dropping multiple certificates on the host, and yeah they can be hidden, but it’s increasing the footprint we leave which increases the risk you have of being discovered. I believe the certificates required is the reason you don’t often see this deployed out of specific circumstances. I hope to continue working on the client/server architecture for this so expect more in the future.&lt;/p&gt;" /><link rel="canonical" href="/posts/lessons-in-c2-from-cia/" /><meta property="og:url" content="/posts/lessons-in-c2-from-cia/" /><meta property="og:site_name" content="Culbert Report" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-11-30T16:22:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Lessons In C2 From The CIA" /><meta name="twitter:site" content="@mattculbert" /><meta name="twitter:creator" content="@Matt C" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Matt C"},"dateModified":"2022-09-06T19:34:41+00:00","datePublished":"2021-11-30T16:22:00+00:00","description":"Intro I&#39;ve always wanted to make my own C2 framework but have never really found the inspiration to, until I came across a post from Byt3bl33d3r talking about modernizing the CIA&#39;s C2 framework. This was somehow the first time I had come across a paper regarding Switchblade and Hive and I wanted to try and set up a mock version for myself. A Quick Review Of mTLS Before getting into the gritty details of this, let&#39;s review/introduce mTLS. mTLS stands for mutual authentication TLS. This is often implemented in zero-trust environments so that the client knows the server is who they say they are and vice-versa. Where a server normally only presents its certificate to connecting clients and then completes connections, mTLS adds the extra step of the client presenting their certificate so that the server can then verify them. The CIA developed Switchblade to use mTLS to authenticate beacon requests to the C2 server and send everyone else to a fake cover site. It can be seen in the diagram below taken from the Vault 7 leaks. &lt;p&gt;&lt;/p&gt;&lt;h2 style=&quot;text-align: left;&quot;&gt;How Can We Leverage This?&lt;/h2&gt;&lt;p style=&quot;text-align: left;&quot;&gt;I haven’t seen a FOSS C2 framework specifically utilizing mTLS yet. There have been quite a few using HTTPS and that’s fantastic, but it’s always fun to take things one step further. In an engagement, when an analyst examines unusual traffic from workstations, forwarding those unauthenticated queries from them to something like google.com provides a minor level of credibility. Taking that further, you could even host your operations in the Google cloud so when they examine the IP it shows up as being owned by Google. This provides far more cover then returning a server error and sort of allows one to hide in plain sight.&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;&lt;/p&gt;&lt;h4 style=&quot;text-align: left;&quot;&gt; Now into the details of the project.&lt;/h4&gt;&lt;h4 style=&quot;text-align: left;&quot;&gt;Generating certs &lt;/h4&gt;&lt;p style=&quot;text-align: left;&quot;&gt;It took me a little bit to figure out how to properly generate certs for mTLS that work well with our transparent proxy configuration until I came across this resource. I recommend following along with what they have written as it works flawlessly. Just ensure that your CN name matches up with the server name you’ll be routing to, otherwise you’ll encounter errors.&lt;/p&gt;&lt;h4 style=&quot;text-align: left;&quot;&gt;Nginx conf&lt;/h4&gt;&lt;p&gt;The config for Nginx goes into /etc/nginx/conf.d/ and can be found here. There’s nothing super fancy here, it’s primarily the one leaked from the CIA and it uses an if statement to check the supplied certificates. If it fails, the client is transparently redirected to the cover site. We did add a few lines specifically that nginx documents as needed for facilitating websockets, but that’s it. People familiar with nginx will notice that the websocket upgrade arguments are outside of where they should go according to documentation, but this was how it worked without errors and, while troubleshooting this, I noticed that CIA also had it setup this way.&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;&lt;/p&gt;&lt;h4 style=&quot;text-align: left;&quot;&gt;Back-end server&lt;/h4&gt;&lt;div style=&quot;text-align: left;&quot;&gt;For the server, it started as a Node project that nginx uses in their example documentation for websockets. A client connects and checks in with a simple “hello” and then the server fires off a response. After the client check in, they are appended to an array and logged. This has it’s shortcomings. Only one client seems to be able to stay connected at a time so we need a better solution. Thankfully, Node is super popular and I found someone who was handling multiple websockets very quickly! Find this here.&lt;/div&gt;&lt;h4 style=&quot;text-align: left;&quot;&gt;Client&lt;/h4&gt;&lt;p style=&quot;text-align: left;&quot;&gt;Python makes a fantastic test bed to get this up and running super quickly. Super quick might be a reach because the amount written on websockets and mTLS in Python is very sparse compared to other areas. But we’re getting ahead of ourselves. &lt;/p&gt;&lt;p style=&quot;text-align: left;&quot;&gt;Before this, I should talk about what was tried and what failed. This started with doing web requests through Python to a back-end web server, with nginx routing it based off of certificates supplied or not. Which worked fine, the web requests were all routed correctly and they retrieved the page, but there was a hitch. This isn’t an ideal solution in any way because the HTTP protocol is unidirectional and operates on a request response method. Once data is finished being sent, the connection is closed. Passing commands over GET requests is finicky and not very dynamic.  &lt;/p&gt;&lt;p style=&quot;text-align: left;&quot;&gt;I next turned to sockets. Sockets are fantastic but fall just short of the mark here because, with the nginx configuration, I was able to send HTTP GET requests but was not able to get a socket to communicate back and forth through this transparent proxy.&lt;/p&gt;&lt;p style=&quot;text-align: left;&quot;&gt;What’s the solution? Websockets. Nginx out of the box actually supports these really well and we can even see the CIA implementing the start of one in the example configuration leaked. Websockets big advantage is that they allow for bidirectional communication and they work easily with the transparent proxy.&lt;/p&gt;&lt;p style=&quot;text-align: left;&quot;&gt;Find the code for this here. For my example I smashed two projects together from here and here. The interaction between the client and server looks like this.&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;&lt;/p&gt;&lt;p style=&quot;text-align: left;&quot;&gt;Update: We’ve got an interactive shell now!&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;&lt;/p&gt;&lt;h4 style=&quot;text-align: left;&quot;&gt;Client in alternative languages&lt;/h4&gt;&lt;h4 style=&quot;text-align: left;&quot;&gt;&lt;/h4&gt;&lt;p style=&quot;text-align: left;&quot;&gt;Alongside creating the Python client/server, I also wanted something which could more traditionally be compiled into an executable. We have a few candidates we can look at for this, I’m thinking Go or C#. Both languages are well documented, memory safe, and have very strong built in libraries. Unfortunately, I’m not super familiar with developing apps in either, so this will be an adventure. Expect more on this soon.&lt;/p&gt;&lt;h4 style=&quot;text-align: left;&quot;&gt;Following the CIA’s recommendations&lt;/h4&gt;&lt;p style=&quot;text-align: left;&quot;&gt;Since this is the CIA’s general idea for command and control infrastructure, we might as well follow their recommendations for the implant. The CIA, alongside creating Switchblade, have a number of dos/donts for creating malware so as to avoid attribution and detection. These are great tips in general to make detection more difficult which is important in red team engagements. We’ve got to make sure our beacon traffic can’t be replayed, the traffic is encrypted on the wire, the executable leaves a small footprint and is under 150kb, and that we obfuscate or encrypt any sensitive strings internally. There are others, but this is just a baseline. &lt;/p&gt;&lt;p style=&quot;text-align: left;&quot;&gt;Right off the bat, we’re not going to be able to keep any compiled Python based executable under 1000kb, let alone 150kb, so we’ll have to look at other languages for that. We have ensured though that communication between the beacon and the server is encrypted and it can’t be replayed either. This leaves sensitive strings, which certs could fall under. In my beacon example, I just pass the directory and file to read from. But in a deployable version, you will want to incorporate these into the program. In Python, this is a little tricky as the sslSettings.load_cert_chain takes a cert file, not a variable with the cert as a string. So if you wanted to deploy this, you would need to deploy the cert file alongside - which is honestly an annoying short coming. How big of a deal this is depends on you. In Windows, we can add the certs to the cert chain and go from there, but the point is that we need to drop more than one file to make this work and you’ll be expanding your footprint.&lt;/p&gt;&lt;h2 style=&quot;text-align: left;&quot;&gt;Conclusion&lt;/h2&gt;&lt;p style=&quot;text-align: left;&quot;&gt;This was a pretty challenging project for me personally but I’m happy that I got the bare bones of it working the way I envisioned. I really want to get the PE version of the beacon setup so that I can do a mock red team exercise with a couple of Windows servers, server 2019 DC’s, an ELK Security stack, and good ol’ Windows Defender, but that’s for the future. I think this provides a good base to build off of. If we look at a packet capture of this on the wire, we can see all the transmitted data is encrypted. Additionally, nothing can be replayed to the C2 server.&lt;/p&gt;&lt;h4 style=&quot;text-align: left;&quot;&gt;&lt;/h4&gt;&lt;p style=&quot;text-align: left;&quot;&gt;I’m annoyed that I can’t seem to find a way around dropping multiple certificates on the host, and yeah they can be hidden, but it’s increasing the footprint we leave which increases the risk you have of being discovered. I believe the certificates required is the reason you don’t often see this deployed out of specific circumstances. I hope to continue working on the client/server architecture for this so expect more in the future.&lt;/p&gt;","headline":"Lessons In C2 From The CIA","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/lessons-in-c2-from-cia/"},"url":"/posts/lessons-in-c2-from-cia/"}</script><title>Lessons In C2 From The CIA | Culbert Report</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Culbert Report"><meta name="application-name" content="Culbert Report"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/thumb.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Culbert Report</a></div><div class="site-subtitle font-italic">Get in loser, we're hating AI and bringing back real learning. Site art by Kenton Drumm</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/matt-culbert" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/mattculbert" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['matt','culbertreport.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Lessons In C2 From The CIA</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Lessons In C2 From The CIA</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1638289320" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Nov 30, 2021 </em> </span> <span> Updated <em class="" data-ts="1662492881" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 6, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href=""></a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1366 words"> <em>7 min</em> read</span></div></div></div><div class="post-content"><h2 style="text-align: left;">Intro</h2><p style="text-align: left;">I've always wanted to make my own C2 framework but have never really found the inspiration to, until I came across a post from Byt3bl33d3r talking about <a href="https://byt3bl33d3r.substack.com/p/taking-the-pain-out-of-c2-infrastructure-3c4" rel="nofollow" target="_blank">modernizing the CIA's C2 framework</a>. This was somehow the first time I had come across a paper regarding Switchblade and Hive and I wanted to try and set up a mock version for myself.<br /></p><h2 style="text-align: left;">A Quick Review Of mTLS</h2><p style="text-align: left;">Before getting into the gritty details of this, let's review/introduce mTLS. mTLS stands for mutual authentication TLS. This is often implemented in zero-trust environments so that the client knows the server is who they say they are and vice-versa. Where a server normally only presents its certificate to connecting clients and then completes connections, mTLS adds the extra step of the client presenting their certificate so that the server can then verify them. The CIA developed Switchblade to use mTLS to authenticate beacon requests to the C2 server and send everyone else to a fake cover site. It can be seen in the diagram below taken from the Vault 7 leaks.<br /></p><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEgx26sLKEIDIjxHjpBJlhn0-jfJ449ZHaan46ygweRNpeHEBVW-y9Q7173kY2aei_EvgYEcgHcs4EiaQRNVM8D3ZYdzlloPVnGToFNpmwAeL3j3Hnybjs8heBfJJtfIbHmhRGObLshV_USQ39HGgU611Cz8BvuIv8uNwDGWd1eeG8Vsv0k8pkTAHlVzgA=s896" style="margin-left: 1em; margin-right: 1em;" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 494 272'%3E%3C/svg%3E" border="0" data-original-height="492" data-original-width="896" height="272" data-src="https://blogger.googleusercontent.com/img/a/AVvXsEgx26sLKEIDIjxHjpBJlhn0-jfJ449ZHaan46ygweRNpeHEBVW-y9Q7173kY2aei_EvgYEcgHcs4EiaQRNVM8D3ZYdzlloPVnGToFNpmwAeL3j3Hnybjs8heBfJJtfIbHmhRGObLshV_USQ39HGgU611Cz8BvuIv8uNwDGWd1eeG8Vsv0k8pkTAHlVzgA=w494-h272" width="494" class="lazyload" data-proofer-ignore></a></div><br /><p></p><h2 style="text-align: left;">How Can We Leverage This?</h2><p style="text-align: left;">I haven't seen a FOSS C2 framework specifically utilizing mTLS yet. There have been quite a few using HTTPS and that's fantastic, but it's always fun to take things one step further. In an engagement, when an analyst examines unusual traffic from workstations, forwarding those unauthenticated queries from them to something like google.com provides a minor level of credibility. Taking that further, you could even host your operations in the Google cloud so when they examine the IP it shows up as being owned by Google. This provides far more cover then returning a server error and sort of allows one to hide in plain sight.</p><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEh-IGcseu2eHiQN5Blc8AyH5a5-UKrVNZzNX0y9e71Lb5NvENneYFIeZP9O7XytzK3HB7wGAWasGN88FfZOoRoVhdg4hmeVYvCPy5-IKfYkcVrc8WTX323L44Bdx78CRmnwlM7iYuNEaKL6__xWaLFrucqc4EPHsE5TFX9gc2THllt1SH8I68rEccyG0Q=s1595" style="margin-left: 1em; margin-right: 1em;" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 517 158'%3E%3C/svg%3E" border="0" data-original-height="490" data-original-width="1595" height="158" data-src="https://blogger.googleusercontent.com/img/a/AVvXsEh-IGcseu2eHiQN5Blc8AyH5a5-UKrVNZzNX0y9e71Lb5NvENneYFIeZP9O7XytzK3HB7wGAWasGN88FfZOoRoVhdg4hmeVYvCPy5-IKfYkcVrc8WTX323L44Bdx78CRmnwlM7iYuNEaKL6__xWaLFrucqc4EPHsE5TFX9gc2THllt1SH8I68rEccyG0Q=w517-h158" width="517" class="lazyload" data-proofer-ignore></a></div><p></p><h4 style="text-align: left;"><span style="font-weight: normal;">&nbsp;Now into the details of the project.</span><br /></h4><h4 style="text-align: left;">Generating certs&nbsp;</h4><p style="text-align: left;">It took me a little bit to figure out how to properly generate certs for mTLS that work well with our transparent proxy configuration until I came across <a href="https://medium.com/geekculture/mtls-with-nginx-and-nodejs-e3d0980ed950" rel="nofollow" target="_blank">this resource</a>. I recommend following along with what they have written as it works flawlessly. Just ensure that your CN name matches up with the server name you'll be routing to, otherwise you'll encounter errors.<br /></p><h4 style="text-align: left;">Nginx conf</h4><p>The config for Nginx goes into /etc/nginx/conf.d/ and can be found <a href="https://github.com/matt-culbert/OffSec/blob/main/Switchblade/nginx.conf" target="_blank">here</a>. There's nothing super fancy here, it's primarily the one leaked from the CIA and it uses an if statement to check the supplied certificates. If it fails, the client is transparently redirected to the cover site. We did add a few lines specifically that nginx documents as needed for facilitating websockets, but that's it. People familiar with nginx will notice that the websocket upgrade arguments are outside of where they should go according to documentation, but this was how it worked without errors and, while troubleshooting this, I noticed that CIA also had it setup this way.</p><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEhjZJOy5DnO7zRVAJs3C9GL1YCGzu6jODN3cL_7_mehep46jwJnHySMfJKVnNYzR-q_MsTuh45dnwz97YQfHBwURxQI68c2HD6t90C-Jdb1TP3u8FaF6NXcM7YBxsVv6VhYJE1PMby5jrBdxtn2MHHBDV7LIEMDqROvVRuuqqfQ9zlAk1GC4gZ9nyi3OA=s807" style="margin-left: 1em; margin-right: 1em;" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 464 274'%3E%3C/svg%3E" border="0" data-original-height="477" data-original-width="807" height="274" data-src="https://blogger.googleusercontent.com/img/a/AVvXsEhjZJOy5DnO7zRVAJs3C9GL1YCGzu6jODN3cL_7_mehep46jwJnHySMfJKVnNYzR-q_MsTuh45dnwz97YQfHBwURxQI68c2HD6t90C-Jdb1TP3u8FaF6NXcM7YBxsVv6VhYJE1PMby5jrBdxtn2MHHBDV7LIEMDqROvVRuuqqfQ9zlAk1GC4gZ9nyi3OA=w464-h274" width="464" class="lazyload" data-proofer-ignore></a></div><p></p><h4 style="text-align: left;">Back-end server</h4><div style="text-align: left;">For the server, it started as a Node project that nginx uses in their <a href="https://www.nginx.com/blog/websocket-nginx/" rel="nofollow" target="_blank">example documentation</a> for websockets. A client connects and checks in with a simple "hello" and then the server fires off a response. After the client check in, they are appended to an array and logged. This has it's shortcomings. Only one client seems to be able to stay connected at a time so we need a better solution. Thankfully, Node is super popular and I <a href="https://medium.com/@willrigsbee/how-to-keep-track-of-clients-with-websockets-1a018c23bbfc" rel="nofollow" target="_blank">found someone</a> who was handling multiple websockets very quickly! Find this <a href="https://github.com/matt-culbert/OffSec/blob/main/Switchblade/server.js" rel="nofollow" target="_blank">here</a>.<br /></div><h4 style="text-align: left;">Client</h4><p style="text-align: left;">Python makes a fantastic test bed to get this up and running super quickly. Super quick might be a reach because the amount written on websockets and mTLS in Python is very sparse compared to other areas. But we're getting ahead of ourselves.&nbsp;</p><p style="text-align: left;">Before this, I should talk about what was tried and what failed. This started with doing web requests through Python to a back-end web server, with nginx routing it based off of certificates supplied or not. Which worked fine, the web requests were all routed correctly and they retrieved the page, but there was a hitch. This isn't an ideal solution in any way because the HTTP protocol is unidirectional and operates on a request response method. Once data is finished being sent, the connection is closed. Passing commands over GET requests is finicky and not very dynamic.&nbsp; <br /></p><p style="text-align: left;">I next turned to sockets. Sockets are fantastic but fall just short of the mark here because, with the nginx configuration, I was able to send HTTP GET requests but was not able to get a socket to communicate back and forth through this transparent proxy.<br /></p><p style="text-align: left;">What's the solution? Websockets. Nginx out of the box actually supports these really well and we can even see the CIA implementing the start of one in the example configuration leaked. Websockets big advantage is that they allow for bidirectional communication and they work easily with the transparent proxy.</p><p style="text-align: left;">Find the code <a href="https://github.com/matt-culbert/OffSec/blob/main/Switchblade/websocket.py" target="_blank">for this here</a>. For my example I smashed two projects together from <a href="https://github.com/matt-culbert/OffSec/blob/main/Switchblade/deprecated-client.py" target="_blank">here</a> and <a href="https://github.com/aaugustin/websockets/blob/34aaf6bcbbac62d8c605d5ba768709346ef87c6e/example/secure_client.py" target="_blank">here</a>. The interaction between the client and server looks like this.</p><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEhi_uSQ9LirnTgSqMCVIDlD4a-Xt6UfEk-m3HW0ui40PrQC9rJelDOHr1OEhQYL2VDcjP_znvM7djH8Ahb79KS0WVejZRqMFwolzo-7ZkcZllKvpH5KXHLHmDneD9bXvZl6t8-WZihDTCaaWBTow9X1yPSCbQYud4NZwO3SNkVdz0XP76oG7XxlMXXdCw=s444" style="margin-left: 1em; margin-right: 1em;" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 320 125'%3E%3C/svg%3E" border="0" data-original-height="173" data-original-width="444" height="125" data-src="https://blogger.googleusercontent.com/img/a/AVvXsEhi_uSQ9LirnTgSqMCVIDlD4a-Xt6UfEk-m3HW0ui40PrQC9rJelDOHr1OEhQYL2VDcjP_znvM7djH8Ahb79KS0WVejZRqMFwolzo-7ZkcZllKvpH5KXHLHmDneD9bXvZl6t8-WZihDTCaaWBTow9X1yPSCbQYud4NZwO3SNkVdz0XP76oG7XxlMXXdCw=s320" width="320" class="lazyload" data-proofer-ignore></a></div><p></p><p style="text-align: left;">Update: We've got an interactive shell now!</p><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEjFWGMM_ZUEAhfZqOtUaVjycSq5brRsrttySRgb37VuC6S2uRKDkDlQzuctUaP3pHMudig_ImkmZ1gFcfGlIi3BdVBAKA3xsFQ4Hqjbbf5Z74zyNNsdUBagbWh6QVm96GvnHOoFh0FrQdTb7YFhqJ0AKGXaXwacnDtZhQ-vCKVsEmj3bnrEGGi8ZrHNuA=s614" imageanchor="1" style="margin-left: 1em; margin-right: 1em;" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 371 361'%3E%3C/svg%3E" border="0" data-original-height="597" data-original-width="614" height="361" data-src="https://blogger.googleusercontent.com/img/a/AVvXsEjFWGMM_ZUEAhfZqOtUaVjycSq5brRsrttySRgb37VuC6S2uRKDkDlQzuctUaP3pHMudig_ImkmZ1gFcfGlIi3BdVBAKA3xsFQ4Hqjbbf5Z74zyNNsdUBagbWh6QVm96GvnHOoFh0FrQdTb7YFhqJ0AKGXaXwacnDtZhQ-vCKVsEmj3bnrEGGi8ZrHNuA=w371-h361" width="371" class="lazyload" data-proofer-ignore></a></div><p></p><h4 style="text-align: left;">Client in alternative languages<br /></h4><h4 style="text-align: left;"></h4><p style="text-align: left;">Alongside creating the Python client/server, I also wanted something which could more traditionally be compiled into an executable. We have a few candidates we can look at for this, I'm thinking Go or C#. Both languages are well documented, memory safe, and have very strong built in libraries. Unfortunately, I'm not super familiar with developing apps in either, so this will be an adventure. Expect more on this soon.<br /></p><h4 style="text-align: left;">Following the CIA's recommendations</h4><p style="text-align: left;">Since this is the CIA's general idea for command and control infrastructure, we might as well follow their recommendations for the implant. The CIA, alongside creating Switchblade, have a number of dos/donts for creating malware so as to avoid attribution and detection. These are great tips in general to make detection more difficult which is important in red team engagements. We've got to make sure our beacon traffic can't be replayed, the traffic is encrypted on the wire, the executable leaves a small footprint and is under 150kb, and that we obfuscate or encrypt any sensitive strings internally. There are others, but this is just a baseline. <br /></p><p style="text-align: left;">Right off the bat, we're not going to be able to keep any compiled Python based executable under 1000kb, let alone 150kb, so we'll have to look at other languages for that. We have ensured though that communication between the beacon and the server is encrypted and it can't be replayed either. This leaves sensitive strings, which certs could fall under. In my beacon example, I just pass the directory and file to read from. But in a deployable version, you will want to incorporate these into the program. In Python, this is a little tricky as the <span style="font-family: courier;">sslSettings.load_cert_chain</span> takes a cert file, not a variable with the cert as a string. So if you wanted to deploy this, you would need to deploy the cert file alongside - which is honestly an annoying short coming. How big of a deal this is depends on you. In Windows, we can add the certs to the cert chain and go from there, but the point is that we need to drop more than one file to make this work and you'll be expanding your footprint.<br /></p><h2 style="text-align: left;">Conclusion</h2><p style="text-align: left;">This was a pretty challenging project for me personally but I'm happy that I got the bare bones of it working the way I envisioned. I really want to get the PE version of the beacon setup so that I can do a mock red team exercise with a couple of Windows servers, server 2019 DC's, an ELK Security stack, and good ol' Windows Defender, but that's for the future. I think this provides a good base to build off of. If we look at a packet capture of this on the wire, we can see all the transmitted data is encrypted. Additionally, nothing can be replayed to the C2 server.<br /></p><h4 style="text-align: left;"></h4><p style="text-align: left;">I'm annoyed that I can't seem to find a way around dropping multiple certificates on the host, and yeah they can be hidden, but it's increasing the footprint we leave which increases the risk you have of being discovered. I believe the certificates required is the reason you don't often see this deployed out of specific circumstances. I hope to continue working on the client/server architecture for this so expect more in the future.<br /></p></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Lessons%20In%20C2%20From%20The%20CIA%20-%20Culbert%20Report&url=%2Fposts%2Flessons-in-c2-from-cia%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Lessons%20In%20C2%20From%20The%20CIA%20-%20Culbert%20Report&u=%2Fposts%2Flessons-in-c2-from-cia%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Flessons-in-c2-from-cia%2F&text=Lessons%20In%20C2%20From%20The%20CIA%20-%20Culbert%20Report" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Making-Red-Teaming-Safer/">Making Red Teaming Safer</a><li><a href="/posts/Human-Learning-Is-Irreplaceable/">Human Learning Is Irreplaceable</a><li><a href="/posts/Building-A-Detection-Lab-Around-Suricata/">Building A Detection Lab Around Suricata</a><li><a href="/posts/The-evolution-of-evasion/">The Evolution Of Evasion</a><li><a href="/posts/C2-Smackdown-Empire-vs-Mythic/">C2 Smackdown Empire Vs Mythic</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/redteam/">redteam</a> <a class="post-tag" href="/tags/c2/">c2</a> <a class="post-tag" href="/tags/container/">container</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/graphana/">graphana</a> <a class="post-tag" href="/tags/jira/">jira</a> <a class="post-tag" href="/tags/nessus/">nessus</a> <a class="post-tag" href="/tags/non-technical/">non-technical</a> <a class="post-tag" href="/tags/nuages/">nuages</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/We-have-lost-the-plot-with-LLMs/"><div class="card-body"> <em class="small" data-ts="1771804800" data-df="ll" > Feb 23, 2026 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>We Have Lost The Plot With Llms</h3><div class="text-muted small"><p> We’ve collectively lost the plot In IT and security we say that users are the weakest link, but this is no longer true; now, the weakest link is whatever LLM your company is using to act as both a ...</p></div></div></a></div><div class="card"> <a href="/posts/Language-models-cannot-make-art/"><div class="card-body"> <em class="small" data-ts="1770249600" data-df="ll" > Feb 5, 2026 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Language Models Cannot Make Art</h3><div class="text-muted small"><p> I was in a random coffee shop a few months back and I noticed that they had little “coffee table” books for sale. One that caught my eye was a Japanese color combination dictionary, originally prin...</p></div></div></a></div><div class="card"> <a href="/posts/Human-Learning-Is-Irreplaceable/"><div class="card-body"> <em class="small" data-ts="1759881600" data-df="ll" > Oct 8, 2025 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Human Learning Is Irreplaceable</h3><div class="text-muted small"><p> What we call “AI” is really just a cancer attacking our ability to learn and we have very little time remaining to carve it out. A note When I began writing this, it was June in Vermont and one ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/custom-encoding-for-shellcode/" class="btn btn-outline-primary" prompt="Older"><p>Custom Encoding For Shellcode</p></a> <a href="/posts/detecting-when-someone-isnt-who-they/" class="btn btn-outline-primary" prompt="Newer"><p>Detecting When Someone Isnt Who They Say They Are</p></a></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/redteam/">redteam</a> <a class="post-tag" href="/tags/c2/">c2</a> <a class="post-tag" href="/tags/container/">container</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/graphana/">graphana</a> <a class="post-tag" href="/tags/jira/">jira</a> <a class="post-tag" href="/tags/nessus/">nessus</a> <a class="post-tag" href="/tags/non-technical/">non-technical</a> <a class="post-tag" href="/tags/nuages/">nuages</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2026 <a href="https://twitter.com/">Matt Culbert</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
