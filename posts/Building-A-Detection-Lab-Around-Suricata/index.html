<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Building A Detection Lab Around Suricata" /><meta property="og:locale" content="en" /><meta name="description" content="I like writing into the void" /><meta property="og:description" content="I like writing into the void" /><link rel="canonical" href="/posts/Building-A-Detection-Lab-Around-Suricata/" /><meta property="og:url" content="/posts/Building-A-Detection-Lab-Around-Suricata/" /><meta property="og:site_name" content="Culbert Report" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-07-11T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Building A Detection Lab Around Suricata" /><meta name="twitter:site" content="@mattculbert" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-09-10T18:08:10+00:00","datePublished":"2024-07-11T00:00:00+00:00","description":"I like writing into the void","headline":"Building A Detection Lab Around Suricata","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/Building-A-Detection-Lab-Around-Suricata/"},"url":"/posts/Building-A-Detection-Lab-Around-Suricata/"}</script><title>Building A Detection Lab Around Suricata | Culbert Report</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Culbert Report"><meta name="application-name" content="Culbert Report"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/thumb.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Culbert Report</a></div><div class="site-subtitle font-italic">Get in loser, we're hating AI and bringing back real learning. Site art by Kenton Drumm</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/matt-culbert" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/mattculbert" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['matt','culbertreport.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Building A Detection Lab Around Suricata</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Building A Detection Lab Around Suricata</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1720656000" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jul 11, 2024 </em> </span> <span> Updated <em class="" data-ts="1757527690" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 10, 2025 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/">Matt Culbert</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4528 words"> <em>25 min</em> read</span></div></div></div><div class="post-content"><style> @font-face { font-family: 'TX-02'; src: url('/assets/lib/fonts/TX-02-Regular.woff2') format('woff2'); font-weight: normal; font-style: normal; } body { font-family: 'TX-02', sans-serif; }</style><h1 id="building-a-detection-lab-around-suricata">Building A Detection Lab Around Suricata</h1><p>A while back there were a flurry of posts from different people about how they were configuring their homelabs, rebuilding them to do X better than something else normally used, and automating this and that. My interest was piqued since I hadn’t played around with my equipment in a while, so I started writing up a post of my own in order to join the fray. Obviously I had to differentiate myself so I chose to focus on the networking aspect of homelabs and started configuring OPNsense. The original goal wasn’t to focus on Suricata, just to briefly mention it before moving on to other things.</p><p>As building OPNsense progressed, I found the documentation around Suricata’s use in OPNsense to be very small. Not many people had touched it and done configurations beyond loading some custom Suricata rules, and what there was written on that was also quite small. At the same time, I also kept seeing a common trend that network based IDS solutions were falling out of favor due to the ubiquity of encryption everywhere. Never one to back down from a challenge, I took it upon myself to try and prove the nay-sayers wrong.</p><p>By the end of this post, I hope to have accomplished two goals. The first is giving the reader a better alternative to a generic traffic log collection endpoint by setting up OPNsense. OPNsense comes with a log management system preconfigured that will be on par with any other free solution you want to ship them off to. The second goal is to learn more about alerting and counter measures to malware traffic. Suricata has a lot of options available to you with a bit of tinkering. While this post will focus primarily on the pre-requisite setup, more posts down the line will dive deep into network based countermeasures. Don’t fret, there will be some discussion on rules and their corresponding alerts.</p><p>Bear with me through the setup process, there’s a lot that needs to be done before moving onto the fun bit of actually writing these rules. If you want to skip the setup for OPNsense and go straight to the section on generating traffic samples and writing detections, <a href="#generating-and-analyzing-attack-traffic">you can click here</a> or just scroll down to the relevant parts. There is also a ton of setup required for enabling Lua for Suricata, and that has its own section dedicated to it.</p><blockquote><p><strong>NOTE</strong> There is an assumption of baseline skills or the ability to search unknown terms and learn on the fly. Things like CIDR notation, what a subnet is, how to exit Vi, that won’t be reviewed.</p></blockquote><h2 id="the-hypervisor"><span class="mr-2">The Hypervisor</span><a href="#the-hypervisor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Starting from the top, the hypervisor being used. I am choosing to use Proxmox. Proxmox ships with their enterprise updates configured, so if you don’t have a license you will need to disable these. Don’t skip this step, it’s important to make sure that you’re updating from the correct repositories otherwise you won’t get any updates. Proxmox <a href="https://pve.proxmox.com/wiki/Package_Repositories">outlines the process here</a> but I’ve also included a brief summary of the steps below. Note that <code class="language-plaintext highlighter-rouge">bookworm</code> is the latest release I am configuring but in the future this will change. Adjust to your needs.</p><p>Configure Proxmox to update from the non-enterprise repository by moving the enterprise repo to a backup location <code class="language-plaintext highlighter-rouge">/etc/apt/sources.list.d/pve-enterprise.list</code> and then creating <code class="language-plaintext highlighter-rouge">/etc/apt/sources.list.d/pve-no-subscription.list</code> with the below content.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription
</pre></table></code></div></div><p>Next configure the <code class="language-plaintext highlighter-rouge">/etc/apt/sources.list</code> file.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>deb http://ftp.debian.org/debian bookworm main contrib
deb http://ftp.debian.org/debian bookworm-updates main contrib

<span class="c"># security updates</span>
deb http://security.debian.org/debian-security bookworm-security main contrib
</pre></table></code></div></div><p>Once this is done, run <code class="language-plaintext highlighter-rouge">apt update</code> and you should be able to pull the latest updates.</p><p>Alternatively, there is a script available to do all the <a href="https://github.com/tteck/Proxmox/raw/main/misc/post-pve-install.sh">configurations for you available here</a>. Of course, please review the script and what it executes before running it yourself. The script will handily also disable the subscription nag prompt and adjust some other quality of life things like the HA configuration which most don’t need.</p><p>Next, we need to configure the primary <code class="language-plaintext highlighter-rouge">VNet</code> and our secondary unmanaged <code class="language-plaintext highlighter-rouge">VNets</code>. Proxmox has <a href="https://pve.proxmox.com/wiki/Setup_Simple_Zone_With_SNAT_and_DHCP">another helpful guide for that here</a> which includes the <code class="language-plaintext highlighter-rouge">apt</code> installs and configuration changes, but again I’ve documented the steps below. This lab configuration requires three <code class="language-plaintext highlighter-rouge">VNets</code>. The first VNet will have a subnet defined and SNAT enabled as this will be the route out to the internet, but the other two will be left to be managed by OPNsense.</p><p>Access the Proxmox shell by navigating to the <code class="language-plaintext highlighter-rouge">pve</code> tab under the root <code class="language-plaintext highlighter-rouge">Datacenter</code> directory and then click <code class="language-plaintext highlighter-rouge">&gt;_ Shell</code>. Run <code class="language-plaintext highlighter-rouge">apt install dnsmasq</code> to get a very lightweight DNS/DHCP server. DNSmasq is designed to support small networks and handle the DNS/DHCP requirements, as well as the router advertisements and the network boot and defaults to using the host DNS settings. With that installed, back in the web GUI, navigate to <code class="language-plaintext highlighter-rouge">Datacenter &gt; SDN &gt; Zones</code> and create a new zone. Give it an ID you will recognize if you have multiple (in this case I have <code class="language-plaintext highlighter-rouge">internal</code> and <code class="language-plaintext highlighter-rouge">internet</code>) and ensure you tick the box for <code class="language-plaintext highlighter-rouge">automatic DHCP</code>.</p><p><a href="/assets/img/detection_lab/pxmx_zones.png" class="popup img-link "><img data-src="/assets/img/detection_lab/pxmx_zones.png" alt="pxmx_zones.png" class="lazyload" data-proofer-ignore></a></p><p>With that set, under <code class="language-plaintext highlighter-rouge">SDN</code> navigate to <code class="language-plaintext highlighter-rouge">VNets</code>. This is where <code class="language-plaintext highlighter-rouge">SNAT</code> will be configured to allow one of the <code class="language-plaintext highlighter-rouge">VNets</code> to reach the outside network by forwarding requests. In my case for <code class="language-plaintext highlighter-rouge">VNets</code> I have configured, there is <code class="language-plaintext highlighter-rouge">VNetInt</code>, <code class="language-plaintext highlighter-rouge">OPNsense</code>, and <code class="language-plaintext highlighter-rouge">OPNS2</code>. Only <code class="language-plaintext highlighter-rouge">VNetInt</code> has <code class="language-plaintext highlighter-rouge">SNAT</code> enabled.</p><p><a href="/assets/img/detection_lab/pxmx_vnet.png" class="popup img-link "><img data-src="/assets/img/detection_lab/pxmx_vnet.png" alt="pxmx_vnet.png" class="lazyload" data-proofer-ignore></a></p><p>After all of these steps are completed, navigate up one menu to the <code class="language-plaintext highlighter-rouge">SDN</code> and make sure you hit <code class="language-plaintext highlighter-rouge">apply</code> to apply the changes made.</p><h2 id="the-vms"><span class="mr-2">The VMs</span><a href="#the-vms" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Next, it’s time to setup OPNsense, Kali, and a victim machine to emulate attack traffic to. The victim machine can be anything you want, I chose to use a clone of my Kali machine and set it up on the 3rd <code class="language-plaintext highlighter-rouge">VNet</code>, <code class="language-plaintext highlighter-rouge">OPNS2</code>, to emulate what cross interface traffic looks like.</p><h3 id="opnsense"><span class="mr-2">OPNsense</span><a href="#opnsense" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><blockquote><p><strong>TIP</strong> In this section, you may see IP mismatches between what’s written in one place versus another. For example, one image shows the <code class="language-plaintext highlighter-rouge">WAN</code> as <code class="language-plaintext highlighter-rouge">10.1.1.3</code> and another shows it set to <code class="language-plaintext highlighter-rouge">10.1.1.5</code>. This is because I rebuilt OPNsense to get more documentation pictures and didn’t stick with the same exact IPs, don’t read too much into it</p></blockquote><p>The OPNsense VM is going to be our route to the internet for the two unconfigured <code class="language-plaintext highlighter-rouge">VNets</code> created when setting up the Proxmox networks in the hypervisor step. I chose OPNsense because of issues with PFSense that cropped up after Netgate took over, but a lot of the steps I will go through below are probably translatable from one to the other if you feel more confident using PFSense. My OPNsense VM has two cores, 8GB of RAM, and 64GB of storage. I also configured it with three network adapters, assigning each to a <code class="language-plaintext highlighter-rouge">VNet</code>.</p><p><a href="/assets/img/detection_lab/opns_set_hard_opt.png" class="popup img-link "><img data-src="/assets/img/detection_lab/opns_set_hard_opt.png" alt="opns_set_hard_opt.png" class="lazyload" data-proofer-ignore></a></p><p>After the hardware is set, you’re ready to turn on the OPNsense VM. When you do, you are presented with a few options but you’re not going to bother with them. When asked to import a configuration, select no. For the manual interface assignment, also select no. OPNsense will perform some autoconfigurations and then prompt you to log in. Use the account name <code class="language-plaintext highlighter-rouge">installer</code> and password <code class="language-plaintext highlighter-rouge">opnsense</code> to kick off the install process. Be sure to double check you’re using the correct disk to install to:</p><p><a href="/assets/img/detection_lab/opns_select_hdd.png" class="popup img-link "><img data-src="/assets/img/detection_lab/opns_select_hdd.png" alt="opns_select_hdd.png" class="lazyload" data-proofer-ignore></a></p><p>Again use the default options for everything else and reboot to finally log in as <code class="language-plaintext highlighter-rouge">root</code> with the same password as the <code class="language-plaintext highlighter-rouge">installer</code> account (unless you opted to change it.) Now to configure some interfaces. Your VM right now most likely looks similar to mine below. You only have two interfaces, missing the third that is setup under the hardware options.</p><p><a href="/assets/img/detection_lab/opns_initial_conf.png" class="popup img-link "><img data-src="/assets/img/detection_lab/opns_initial_conf.png" alt="opns_initial_conf.png" class="lazyload" data-proofer-ignore></a></p><p>You will have to use options 1 and 2 in the terminal to set all three interfaces up properly but a bit of fiddling should get you there. For ease of reference, I suggest popping the console out and having it next to your hardware configurations like I have in order to easily see which device is which MAC address.</p><p><a href="/assets/img/detection_lab/opns_set_hardware.png" class="popup img-link "><img data-src="/assets/img/detection_lab/opns_set_hardware.png" alt="opns_set_hardware.png" class="lazyload" data-proofer-ignore></a></p><p>Use option <code class="language-plaintext highlighter-rouge">1</code> to begin configuring the <code class="language-plaintext highlighter-rouge">WAN</code> and select no to the <code class="language-plaintext highlighter-rouge">LAGG</code> and <code class="language-plaintext highlighter-rouge">VLAN</code> options. <code class="language-plaintext highlighter-rouge">LAGG</code> is for link aggregation and we’re not playing with <code class="language-plaintext highlighter-rouge">VLANs</code> right now. Next you will be prompted for the interface name. In my case, <code class="language-plaintext highlighter-rouge">vtnet0</code> in OPNsense has the same hardware ID as the hardware network adapter assigned to the SNAT network in Proxmox so that’s how I know it’s the right choice. Next you will be prompted to enter your <code class="language-plaintext highlighter-rouge">LAN</code> interface name so do the same. This one is more flexible, both the remaining VNets are fine to use here and the one you don’t choose you will just assign to the additional <code class="language-plaintext highlighter-rouge">opt1</code> interface afterwards.</p><p><a href="/assets/img/detection_lab/opns_int_assign.png" class="popup img-link "><img data-src="/assets/img/detection_lab/opns_int_assign.png" alt="opns_int_assign.png" class="lazyload" data-proofer-ignore></a></p><p>Once the interfaces are assigned, you can begin configuring them. Using option <code class="language-plaintext highlighter-rouge">2</code>, begin with setting up the <code class="language-plaintext highlighter-rouge">WAN</code> interface. I’ve opted to manually configure the IPv4/6 addresses, leaving 6 blank for now. Recall the <code class="language-plaintext highlighter-rouge">WAN</code> is the <code class="language-plaintext highlighter-rouge">SNAT</code> network so you need to assign an IP in the range you defined for it in the hypervisor step, along with using the same <code class="language-plaintext highlighter-rouge">gateway</code> and <code class="language-plaintext highlighter-rouge">CIDR</code> notated <code class="language-plaintext highlighter-rouge">subnet</code>.</p><p><a href="/assets/img/detection_lab/opns_set_interface.png" class="popup img-link "><img data-src="/assets/img/detection_lab/opns_set_interface.png" alt="opns_set_interface.png" class="lazyload" data-proofer-ignore></a></p><p>With the <code class="language-plaintext highlighter-rouge">WAN</code> configured, now do the same steps for the <code class="language-plaintext highlighter-rouge">LAN</code> and <code class="language-plaintext highlighter-rouge">OPT1</code> interfaces, just be sure to select a different IP range for each of them. For the sake of clarity when observing traffic, I opted to put them on the <code class="language-plaintext highlighter-rouge">172.16.1.0</code> and <code class="language-plaintext highlighter-rouge">172.17.10.0</code> ranges. The only extra step for these configurations that wasn’t done for the <code class="language-plaintext highlighter-rouge">WAN</code> is to enable the DHCP server, define an IP range, netmask in <code class="language-plaintext highlighter-rouge">CIDR</code> notation, and set a <code class="language-plaintext highlighter-rouge">gateway</code>. The <code class="language-plaintext highlighter-rouge">gateway</code> is what you set as the interface IP in OPNsense. As shown in my configuration, the interfaces each match up with their interface shown in the hardware settings.</p><p><a href="/assets/img/detection_lab/opns_final_conf.png" class="popup img-link "><img data-src="/assets/img/detection_lab/opns_final_conf.png" alt="opns_final_conf.png" class="lazyload" data-proofer-ignore></a></p><p>That’s it for now in the OPNsense terminal, now for our attack box.</p><h3 id="the-attack-box"><span class="mr-2">The Attack Box</span><a href="#the-attack-box" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>This parts the easiest of the whole guide. For the attack box I suggest assigning 4GB of RAM and 2 processors, but this is really preference. Add a new Kali virtual machine and edit the network device so that it uses the LAN bridge configured for OPNsense. This will allow you to reach the OPNsense web management interface and you will have a route from the 172.16.1.0 network through the 10.1.1.0 network out to the internet.</p><p><a href="/assets/img/detection_lab/route-to-internet.png" class="popup img-link "><img data-src="/assets/img/detection_lab/route-to-internet.png" alt="route-to-internet.png" class="lazyload" data-proofer-ignore></a></p><p>For the C2, I want to write Suricata rules relevant to my personal tools, so I’ll be using CloakNDagger. Feel free to use whatever you would prefer though instead.</p><h3 id="final-clean-up-steps"><span class="mr-2">Final Clean Up Steps</span><a href="#final-clean-up-steps" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Assuming you have your attack box on the <code class="language-plaintext highlighter-rouge">LAN</code> interface for OPNsense, navigate to the gateway IP in your web browser and login with the username <code class="language-plaintext highlighter-rouge">root</code> and the same password you’ve been using. I suggest skipping the Wizard you’re prompted to go through on first login. After that, navigate to <code class="language-plaintext highlighter-rouge">Firewall -&gt; Rules -&gt; InterfaceName</code> and add two rules to both the internal interfaces that allow traffic in and out unrestricted. Next, navigate to <code class="language-plaintext highlighter-rouge">Services -&gt; Intrusion Detection -&gt; Administration -&gt; Settings tab</code>, turn the IDS on by checking <code class="language-plaintext highlighter-rouge">Enabled</code>, and then make sure the interfaces that you setup are selected. Mine looks like the below:</p><p><a href="/assets/img/detection_lab/ids_administration.png" class="popup img-link "><img data-src="/assets/img/detection_lab/ids_administration.png" alt="ids_administration.png" class="lazyload" data-proofer-ignore></a></p><p>You’re ready to begin with your attack traffic analysis and rule creation!</p><h2 id="generating-and-analyzing-attack-traffic"><span class="mr-2">Generating And Analyzing Attack Traffic</span><a href="#generating-and-analyzing-attack-traffic" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Now that the different boxes are ready, OPNsense is configured, and traffic is flowing, let’s dive into Suricata. There’s been quite a lot of setup leading up to this but it’ll all have been worth it. Ensuring the lab is configured properly for routing and analyzing traffic is much more arduous than the actual rule writing.</p><h3 id="the-attack-traffic"><span class="mr-2">The Attack Traffic</span><a href="#the-attack-traffic" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Using your C2 of choice, setup a listener and generate a standard payload. Send the payload over to your victim machine and, when you start getting traffic back, you’re ready to begin some monitoring. Go back to the OPNsense web GUI and take a look at traffic flowing through the firewall using <code class="language-plaintext highlighter-rouge">Firewall -&gt; Log Files -&gt; live View</code>. If you don’t see interface to interface traffic and are not getting implant responses, then a firewall rule is probably denying it.</p><h3 id="suricata-rules"><span class="mr-2">Suricata Rules</span><a href="#suricata-rules" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Once you’ve confirmed traffic is flowing from your C2 to the victim machine, you’re ready to start writing Suricata rules. But like everything else in this writeup, there’s a couple prerequisite steps to complete first. Adding custom rules to Suricata is not as simple as writing one and pasting it into the interface. There’s a few methods available but the one I will walk through requires you to host your rule files in a Git repo and to add an XML file to Suricata’s OPNsense configuration. You can follow <a href="https://forum.opnsense.org/index.php?topic=7209.0">the forum post here</a> for the forum thread on adding your custom rules but again I’ve documented the pertinent information below. Thanks, as always, to the original author <code class="language-plaintext highlighter-rouge">dcol</code>.</p><p>Create <code class="language-plaintext highlighter-rouge">custom.xml</code> in the directory <code class="language-plaintext highlighter-rouge">/usr/local/opnsense/scripts/suricata/metadata/rules/</code> and add the following lines:</p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;ruleset</span> <span class="na">documentation_url=</span><span class="s">"http://docs.opnsense.org/"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;location</span> <span class="na">url=</span><span class="s">"https://raw.githubusercontent.com/matt-culbert/suricata_rules/main/"</span> <span class="na">prefix=</span><span class="s">"cnd"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;files&gt;</span>
        <span class="nt">&lt;file</span> <span class="na">description=</span><span class="s">"rules for detecting CND"</span><span class="nt">&gt;</span>cnd.rules<span class="nt">&lt;/file&gt;</span>
        <span class="nt">&lt;file</span> <span class="na">description=</span><span class="s">"Custom"</span> <span class="na">url=</span><span class="s">"inline::rules/cnd.rules"</span><span class="nt">&gt;</span>cnd.rules<span class="nt">&lt;/file&gt;</span>
    <span class="nt">&lt;/files&gt;</span>
<span class="nt">&lt;/ruleset&gt;</span>
</pre></table></code></div></div><p>This file tells Suricata that there’s an additional rule set available to download from the URL specified and it has the prefix <code class="language-plaintext highlighter-rouge">cnd</code> and full file name of <code class="language-plaintext highlighter-rouge">cnd.rules</code>. Be sure to use <code class="language-plaintext highlighter-rouge">raw.githubusercontent.com</code> instead of <code class="language-plaintext highlighter-rouge">github</code> as this will provide services with only the rendered text. With the <code class="language-plaintext highlighter-rouge">custom.xml</code> file created, when you reload the <code class="language-plaintext highlighter-rouge">Download</code> tab of the IDS, you should see that Suricata has an additional option for your repo.</p><p><a href="/assets/img/detection_lab/suricata_custom_rules.png" class="popup img-link "><img data-src="/assets/img/detection_lab/suricata_custom_rules.png" alt="suricata_custom_rules.png" class="lazyload" data-proofer-ignore></a></p><p>Before downloading these rules though, we have to create some first. But what do Suricata rules look like? The documentation is very thorough and can be found <a href="https://docs.suricata.io/en/suricata-7.0.5/rules/index.html">here for version 7.0.5</a>. If you find yourself confused while reading, refer to the docs for a better explanation. Let’s review an example rule. C2’s often use a non-standard port range and alerting on this is simple. In the below example, the rule action is to <code class="language-plaintext highlighter-rouge">alert</code> on traffic that uses the protocol <code class="language-plaintext highlighter-rouge">tcp</code> from a source of the <code class="language-plaintext highlighter-rouge">home_net</code> to a destination that is anything with a <code class="language-plaintext highlighter-rouge">port</code> range higher than the standard reserved. The syntax is very intuitive, in this case <code class="language-plaintext highlighter-rouge">1024:</code> just tells the rule to look for any port above 1024. Traffic flow for the rule is dictated by the <code class="language-plaintext highlighter-rouge">-&gt;</code>, indicating that traffic flowing from the home network to anywhere else will be analyzed, but the reverse won’t be.</p><pre><code class="language-suricata">alert tcp $HOME_NET any -&gt; any 1024: (msg:"A non standard port was requested HOME flow to EXTERNAL"; sid:100000001;)
</code></pre><p>Add the rule to your Git repo and wait for the <code class="language-plaintext highlighter-rouge">githubusercontent</code> domain to update, then you can download and enable it. You’ve got your first rule!</p><p>There’s so much more to rules than that brief example, but I think it’s more beneficial to look at them in context to the scenario we’ve setup. First, we need to get an idea of what the C2 traffic looks like on the wire. OPNsense has a built in tool for just such an occasion. Under <code class="language-plaintext highlighter-rouge">Interfaces -&gt; Diagnostics -&gt; Packet Capture</code> you have the option to launch a packet capture for any interface. Select the appropriate one and, with C2 traffic running between it and your victim machine, begin the PCAP. After a sufficient amount of time with check-ins and command execution, there should be enough data in the PCAP so stop it, download it, and open it in Wireshark. There’s a lot that CloakNDagger gives defenders to begin searching for it on the wire. The first and easiest place to look at is the default certificate that it ships with. Just generate a JA3 fingerprint which Suricata can then use for alerts. Install <code class="language-plaintext highlighter-rouge">JA3</code> on the machine you’re using to look at the PCAP with <code class="language-plaintext highlighter-rouge">pip install pyja3</code> and run <code class="language-plaintext highlighter-rouge">ja3 -a &lt;pcap&gt;</code>. The <code class="language-plaintext highlighter-rouge">-a</code> flag is required to find the <code class="language-plaintext highlighter-rouge">client Hello's</code> on any port:</p><p><a href="/assets/img/detection_lab/ja3_sample_output.png" class="popup img-link "><img data-src="/assets/img/detection_lab/ja3_sample_output.png" alt="ja3_sample_output.png" class="lazyload" data-proofer-ignore></a></p><blockquote><p><strong>NOTE</strong> We will enable JA4 signatures later on when we re-install Suricata as part of the process for enabling Lua</p></blockquote><p>For each stream in the PCAP, <code class="language-plaintext highlighter-rouge">JA3</code> outputs some details about the source and destination and two fingerprints of the server. The <code class="language-plaintext highlighter-rouge">digest</code> field is what will be used for the next rule we will create. These are easy to include in rules, just specify the <code class="language-plaintext highlighter-rouge">ja3.hash</code> flag followed by a <code class="language-plaintext highlighter-rouge">content</code> flag containing that <code class="language-plaintext highlighter-rouge">digest</code>:</p><pre><code class="language-suricata">alert tcp any any -&gt; any any (msg:"Match JA3 digest"; ja3.hash; content:"4287b6079ba0c8f574ae4d871aed15f9"; sid:10000002;)
</code></pre><p>With this in place, the following alert gets generated:</p><p><a href="/assets/img/detection_lab/ja3_alert.png" class="popup img-link "><img data-src="/assets/img/detection_lab/ja3_alert.png" alt="ja3_alert.png" class="lazyload" data-proofer-ignore></a></p><p>That’s all well and good but if that cert is rotated then this is no longer an effective alert. Have no fear, you can alert on quite a few field and <em>multiple</em> fields at the same time. Take for example the TTL seen in requests. While it is consistently <code class="language-plaintext highlighter-rouge">63</code>, this alone isn’t enough to confidently say that seeing it is an IOC. However, combine this with also filtering on the header length, and now the rule is very scoped down to only the malicious traffic. I can confidently say this because in Wireshark you can add filter flags in the PCAP to narrow down your search, and once you’re finished there you can then translate almost all of those into Suricata flags:</p><p><a href="/assets/img/detection_lab/wireshark_traffic_sample.png" class="popup img-link "><img data-src="/assets/img/detection_lab/wireshark_traffic_sample.png" alt="wireshark_traffic_sample.png" class="lazyload" data-proofer-ignore></a></p><pre><code class="language-suricata">alert tcp any any -&gt; any any (msg:"Match header length and TTL"; ipv4.hdr; bsize:20; ttl:63; sid:100000003;)
</code></pre><p><a href="/assets/img/detection_lab/header_ttl_alert.png" class="popup img-link "><img data-src="/assets/img/detection_lab/header_ttl_alert.png" alt="header_ttl_alert.png" class="lazyload" data-proofer-ignore></a></p><p>Zooming back out, a broader pattern that can be alerted on is how low quality C2 configurations generally check-in at a consistent pace. Compare the two traffic samples below, one a check-in process and the other a request for <code class="language-plaintext highlighter-rouge">yahoo.com</code>:</p><p><a href="/assets/img/detection_lab/cnd_traffic.png" class="popup img-link "><img data-src="/assets/img/detection_lab/cnd_traffic.png" alt="cnd_traffic.png" class="lazyload" data-proofer-ignore></a> <a href="/assets/img/detection_lab/yahoo_traffic.png" class="popup img-link "><img data-src="/assets/img/detection_lab/yahoo_traffic.png" alt="yahoo_traffic.png" class="lazyload" data-proofer-ignore></a></p><p>You can see that a series of partial handshakes are being performed regularly and no data is being exchanged, i.e. a check-in is occurring where the C2 is queried for any waiting commands. A high jitter and sleep time can help lower this detection confidence but it’s a very telltale sign of malicious traffic. An alert for this process would look like the following, taking advantage of the <code class="language-plaintext highlighter-rouge">threshold</code> flag to set a required number of occurrences and <code class="language-plaintext highlighter-rouge">track by_src</code> to set which address we are tracking that threshold by:</p><pre><code class="language-suricata">alert tcp any any -&gt; any any (msg: "Matched TCP flags for CND"; tcp.flags:AP; threshold: type threshold, track by_src, count 6, seconds 60; sid:100000004;)
</code></pre><p>Hmm this alert is quite noisy but there is a <code class="language-plaintext highlighter-rouge">type</code> set already as <code class="language-plaintext highlighter-rouge">threshold</code> which means that there can’t be another limiter added. OPNsense again has you covered with the <code class="language-plaintext highlighter-rouge">threshold.config</code> file located in <code class="language-plaintext highlighter-rouge">/usr/local/etc/suricata</code>. This lets you set additional thresholds for any alert. In the case of the above rule, the added threshold will look like the following: <code class="language-plaintext highlighter-rouge">threshold gen_id 1, sig_id 100000004, type limit, track by_src, count 1, seconds 60</code></p><p>Now there should only be one alert per tracked source IP every minute. This can be further adjusted as you see fit for your environment and be done for any rule you need. Which brings us to the crux of Suricata. When writing rules, your environments uniqueness is your strength. You may find that the provided rules here are loud and alert on false positives without additional tuning. That’s the great thing though about these rules, the patterns I set here only picked up the traffic I needed it to. This is only the surface of Suricata and OPNsense - we haven’t even touched the Lua scripting engine that can have traffic offloaded to it for further alert and log generation.</p><h2 id="lua"><span class="mr-2">Lua</span><a href="#lua" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Configuring Suricata to support Lua took maybe the longest part of this whole writeup. There’s little documentation I’ve found from people who have added Lua support to OPNsense instances running the Suricata IDS so, through a <em>lot</em> of trial and error, I’ve tried to document the process here as fully as I can. I’ve walked through these steps a number of times on a fresh VM so I feel fairly confident nothing is missing. If you want to skip the manual configuration, I’ve also compiled the below steps into a <code class="language-plaintext highlighter-rouge">sh</code> script that <a href="https://github.com/matt-culbert/suricata_rules/blob/main/lua_setup.sh">can be downloaded from my Git here</a>.</p><h3 id="configuring-lua-support"><span class="mr-2">Configuring Lua Support</span><a href="#configuring-lua-support" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Out of the box, Lua support is not enabled. You can check this by running <code class="language-plaintext highlighter-rouge">suricata --build-info | grep LUA</code> and you will get an output like the following (if yours <em>is</em> enabled, congrats!):</p><p><a href="/assets/img/detection_lab/suricata_no_lua.png" class="popup img-link "><img data-src="/assets/img/detection_lab/suricata_no_lua.png" alt="suricata_no_lua.png" class="lazyload" data-proofer-ignore></a></p><p>To enable this, there’s a bunch of requirements that need to be met first. To start, Rust needs to be installed alongside a few other <code class="language-plaintext highlighter-rouge">pkg</code> components. To install these requirements run <code class="language-plaintext highlighter-rouge">pkg install lua54 autoconf automake libtool pkgconf wget git</code>. Next up is to download Rust. The download is piped right to <code class="language-plaintext highlighter-rouge">sh</code> which is always risky so review the URL and script before continuing. <code class="language-plaintext highlighter-rouge">curl https://sh.rustup.rs | sh</code> and just use the default options. After Rust is installed, there’s some manual configuration required for adding it to the path. Using <code class="language-plaintext highlighter-rouge">vi</code>, edit <code class="language-plaintext highlighter-rouge">~/.cshrc</code> and at the bottom add the following entries:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>setenv PATH $HOME/.cargo/bin:$PATH
setenv CARGO_HOME $HOME/.cargo
</pre></table></code></div></div><p>Then run <code class="language-plaintext highlighter-rouge">source ~/.cshrc</code> after writing the changes to reload the terminal config.</p><p>Now to update Suricata. Instead of using <code class="language-plaintext highlighter-rouge">git</code> to clone the Suricata repo, which downloads the latest dev release, I suggest using <code class="language-plaintext highlighter-rouge">wget</code> to download the latest <em>stable</em> release. These can be found by navigating to https://github.com/OISF/suricata/releases. When you find a suitable version, download the <code class="language-plaintext highlighter-rouge">tarball</code> with <code class="language-plaintext highlighter-rouge">wget</code> by supplying it with the download URL, then <code class="language-plaintext highlighter-rouge">untar</code> it. Navigate into the new Suricata directory and run <code class="language-plaintext highlighter-rouge">git clone https://github.com/OISF/libhtp</code> to pickup another required library followed by <code class="language-plaintext highlighter-rouge">cargo install --force cbindgen</code> for a missing Rust library. Once both requirements are met, run <code class="language-plaintext highlighter-rouge">./autogen.sh</code>.</p><p>Before running <code class="language-plaintext highlighter-rouge">configure</code> and <code class="language-plaintext highlighter-rouge">make</code>, there’s some manual linking required. Lua is currently setup in paths that Suricata is not looking in and so won’t find it. Resolving this requires creating a few symlinks:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>ln -sf /usr/local/include/lua54/lua.h /usr/include/lua.h 
ln -sf /usr/local/include/lua54/lualib.h /usr/include/lualib.h 
ln -sf /usr/local/include/lua54/lauxlib.h /usr/include/lauxlib.h 
ln -sf /usr/local/include/lua54/luaconf.h /usr/include/luaconf.h
ln -sf /usr/local/include/lua54/ /usr/local/include/lua

ln -sf /usr/local/lib/liblua-5.4.a /usr/local/lib/liblua54.a 
ln -sf /usr/local/lib/liblua-5.4.so /usr/local/lib/liblua54.so

ln -sf /usr/local/libdata/pkgconfig/lua-5.4.pc /usr/local/libdata/pkgconfig/lua.pc
</pre></table></code></div></div><blockquote><p><strong>WARNING</strong> The file <code class="language-plaintext highlighter-rouge">lauxlib.h</code> is not misspelled and you may have misread it the first time. Trying to look out for all the other people reading things too quickly like myself.</p></blockquote><p>We’re getting close to the end, I promise. Two more edits to make sure Lua can be found. Still in your new Suricata directory, run <code class="language-plaintext highlighter-rouge">setenv LUA_CFLAGS "-I/usr/local/include/lua5.4"</code> and <code class="language-plaintext highlighter-rouge">setenv LUA_LIBS "-L/usr/local/lib -llua-5.4"</code>. These are to set compiler flags in the <code class="language-plaintext highlighter-rouge">Makefile</code>. Now it’s finally time to run configure <code class="language-plaintext highlighter-rouge">./configure --enable-lua --with-lua=/usr/local/lib</code> followed by <code class="language-plaintext highlighter-rouge">make &amp;&amp; make install-full</code> to complete the setup. Then just restart the service and when <code class="language-plaintext highlighter-rouge">suricata --build-info | grep LUA</code> is run again, it shows as enabled.</p><blockquote><p><strong>NOTE</strong> Some of the absolute paths I have used may be different for you. If you use one and find that it results in an error while running <code class="language-plaintext highlighter-rouge">make</code>, be sure to re-run <code class="language-plaintext highlighter-rouge">configure</code> after each adjustment you do before you try and run <code class="language-plaintext highlighter-rouge">make</code> again. Some errors may require you to go back a step further and run <code class="language-plaintext highlighter-rouge">./autogen.sh</code> before <code class="language-plaintext highlighter-rouge">configure</code>. When all else fails, start from the top with <code class="language-plaintext highlighter-rouge">make clean</code>, followed by <code class="language-plaintext highlighter-rouge">./autogen.sh</code>, <code class="language-plaintext highlighter-rouge">configure</code>, and <code class="language-plaintext highlighter-rouge">make</code></p></blockquote><p>In addition to Lua being enabled, if you run <code class="language-plaintext highlighter-rouge">suricata --build-info | grep yes</code> you can see all the enabled components. Among these, <code class="language-plaintext highlighter-rouge">JA4</code> is there.</p><h3 id="writing-lua-scripts"><span class="mr-2">Writing Lua Scripts</span><a href="#writing-lua-scripts" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>So you’ve got Lua enabled, but what does a Lua script look like? Suricata’s <a href="https://docs.suricata.io/en/suricata-6.0.18/rules/rule-lua-scripting.html#lua-scripting">documentation is seriously your biggest asset</a>, use it, love it, cherish it. All scripts require an <code class="language-plaintext highlighter-rouge">init</code> function in them which determines which piece of the packet to pull in. For this example, it will be for generating an alert. Alerting has stripped down requirements versus generating a log entry. Note that, depending on what you want to alert on, different packet properties have different <code class="language-plaintext highlighter-rouge">needs</code>. For instance, to analyze TLS packets, the <code class="language-plaintext highlighter-rouge">init</code> function would look like the following:</p><div class="language-lua highlighter-rouge"><div class="code-header"> <span data-label-text="Lua"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">function</span> <span class="nf">init</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">needs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">needs</span><span class="p">[</span><span class="s2">"tls"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tostring</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">needs</span>
<span class="k">end</span>
</pre></table></code></div></div><p>Then, to alert on a self-signed certificate, you would pull out the issuer and subject fields from the certificate and compare them. If it is true that the two fields are the same, the rule has a match and will generate an alert:</p><div class="language-lua highlighter-rouge"><div class="code-header"> <span data-label-text="Lua"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">function</span> <span class="nf">match</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">version</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">issuer</span><span class="p">,</span> <span class="n">fingerprint</span> <span class="o">=</span> <span class="n">TlsGetCertInfo</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">subject</span> <span class="o">==</span> <span class="n">issuer</span> <span class="k">then</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="k">end</span>
<span class="k">return</span> <span class="mi">0</span>
</pre></table></code></div></div><p>Using this script in a rule is simple, just add <code class="language-plaintext highlighter-rouge">lua: script1.lua</code> anywhere you want it to be run. For instance, a simple version would look like this:</p><pre><code class="language-suricata">alert tcp any any -&gt; any any (msg: "Lua script found a self signed cert"; flow:established; lua: script1.lua; tls.store; sid:100000007;)
</code></pre><p>The alert looks for an established flow, which just means that the connection is fully established, and on a match the <code class="language-plaintext highlighter-rouge">tls.store</code> keyword indicates that the cert is stored to the disk. This allows further analysis with <code class="language-plaintext highlighter-rouge">JA3/4</code>. When this alert is triggered, it looks like the below:</p><p><a href="/assets/img/detection_lab/lua_alert.png" class="popup img-link "><img data-src="/assets/img/detection_lab/lua_alert.png" alt="lua_alert.png" class="lazyload" data-proofer-ignore></a></p><p>There’s more than just alerting however, there’s also the option to generate robust log information. By changing the <code class="language-plaintext highlighter-rouge">init</code> function from <code class="language-plaintext highlighter-rouge">needs["tls"] = tostring(true)</code> to <code class="language-plaintext highlighter-rouge">needs["protocol"] = "tls"</code> and the <code class="language-plaintext highlighter-rouge">match</code> function to <code class="language-plaintext highlighter-rouge">log</code>, you can now generate log messages for certain traffic patterns. The <code class="language-plaintext highlighter-rouge">log</code> scripts are more involved than <code class="language-plaintext highlighter-rouge">match</code> scripts as they also require additional <code class="language-plaintext highlighter-rouge">setup</code> functions and <code class="language-plaintext highlighter-rouge">deinit</code> functions, but it’s not a big jump in difficulty. These will be explored more in later posts.</p><h2 id="wrapping-up"><span class="mr-2">Wrapping Up</span><a href="#wrapping-up" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>And that’s it! I would say more than half the guide is dedicated to the proper configuration, but having that correct means way less headaches down the line. I’d add more to the Lua and Suricata sections but this post is very long as is. Best to save that for a future post instead.</p><p>My goal with writing this was to help create a baseline with where to start with OPNsense and lay out some paths to progress with to expand what you’ve created here. You should have a set of interfaces, subnets, and three firewalls to fiddle with in addition to the Suricata and Lua rules.</p><p>If you’re undecided about next steps, one would be to play with the <code class="language-plaintext highlighter-rouge">drop</code> function for alerts. After all, if traffic patterns match your rules for malware, why should they be allowed to keep flowing freely? This will be a real test of your rule writing as you don’t want to inadvertently affect normal traffic flows. Additionally, as I mentioned <code class="language-plaintext highlighter-rouge">JA4</code> support is enabled now for your rule engine, so check out the expanded fields offered.</p><p>While this guide focused almost solely on Suricata, there’s a lot more to OPNsense than just this. Other aspects you can consider are setting up the VPN service. There is a WireGuard VPN built into it and, for those uninitiated, WireGuard has quickly become one of the dominant forces in the VPN industry for good reason. It’s fast, lightweight, and works on about any platform. Or if you want instead, you can start setting up additional interfaces with VLANs and learn more about VLAN tagging. And all of these services can be filtered through the IDS engine you spent so long setting up.</p></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Building%20A%20Detection%20Lab%20Around%20Suricata%20-%20Culbert%20Report&url=%2Fposts%2FBuilding-A-Detection-Lab-Around-Suricata%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Building%20A%20Detection%20Lab%20Around%20Suricata%20-%20Culbert%20Report&u=%2Fposts%2FBuilding-A-Detection-Lab-Around-Suricata%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2FBuilding-A-Detection-Lab-Around-Suricata%2F&text=Building%20A%20Detection%20Lab%20Around%20Suricata%20-%20Culbert%20Report" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Making-Red-Teaming-Safer/">Making Red Teaming Safer</a><li><a href="/posts/Human-Learning-Is-Irreplaceable/">Human Learning Is Irreplaceable</a><li><a href="/posts/Building-A-Detection-Lab-Around-Suricata/">Building A Detection Lab Around Suricata</a><li><a href="/posts/The-evolution-of-evasion/">The Evolution Of Evasion</a><li><a href="/posts/C2-Smackdown-Empire-vs-Mythic/">C2 Smackdown Empire Vs Mythic</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/redteam/">redteam</a> <a class="post-tag" href="/tags/c2/">c2</a> <a class="post-tag" href="/tags/container/">container</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/graphana/">graphana</a> <a class="post-tag" href="/tags/jira/">jira</a> <a class="post-tag" href="/tags/nessus/">nessus</a> <a class="post-tag" href="/tags/non-technical/">non-technical</a> <a class="post-tag" href="/tags/nuages/">nuages</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/We-have-lost-the-plot-with-LLMs/"><div class="card-body"> <em class="small" data-ts="1771804800" data-df="ll" > Feb 23, 2026 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>We Have Lost The Plot With Llms</h3><div class="text-muted small"><p> We’ve collectively lost the plot In IT and security we say that users are the weakest link, but this is no longer true; now, the weakest link is whatever LLM your company is using to act as both a ...</p></div></div></a></div><div class="card"> <a href="/posts/Language-models-cannot-make-art/"><div class="card-body"> <em class="small" data-ts="1770249600" data-df="ll" > Feb 5, 2026 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Language Models Cannot Make Art</h3><div class="text-muted small"><p> I was in a random coffee shop a few months back and I noticed that they had little “coffee table” books for sale. One that caught my eye was a Japanese color combination dictionary, originally prin...</p></div></div></a></div><div class="card"> <a href="/posts/Human-Learning-Is-Irreplaceable/"><div class="card-body"> <em class="small" data-ts="1759881600" data-df="ll" > Oct 8, 2025 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Human Learning Is Irreplaceable</h3><div class="text-muted small"><p> What we call “AI” is really just a cancer attacking our ability to learn and we have very little time remaining to carve it out. A note When I began writing this, it was June in Vermont and one ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Making-Red-Teaming-Safer/" class="btn btn-outline-primary" prompt="Older"><p>Making Red Teaming Safer</p></a> <a href="/posts/Human-Learning-Is-Irreplaceable/" class="btn btn-outline-primary" prompt="Newer"><p>Human Learning Is Irreplaceable</p></a></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/redteam/">redteam</a> <a class="post-tag" href="/tags/c2/">c2</a> <a class="post-tag" href="/tags/container/">container</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/graphana/">graphana</a> <a class="post-tag" href="/tags/jira/">jira</a> <a class="post-tag" href="/tags/nessus/">nessus</a> <a class="post-tag" href="/tags/non-technical/">non-technical</a> <a class="post-tag" href="/tags/nuages/">nuages</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2026 <a href="https://twitter.com/">Matt Culbert</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
