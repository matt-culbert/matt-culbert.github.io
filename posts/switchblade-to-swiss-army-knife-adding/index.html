<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Switchblade To Swiss Army Knife: Expanding The Toolset With Python" /><meta name="author" content="Matt C" /><meta property="og:locale" content="en" /><meta name="description" content="Intro &nbsp;&nbsp; &nbsp;A while ago I posted about Switchblade. This was a C2 technique that utilized mutual TLS to authenticate beacons that were compromised and separate them out from other traffic. I won&#39;t rehash it too much but it was a cool (in my opinion) way to use Nginx to authenticate beacons with an unusual method and would be considered zero trust since the beacon authenticated to the server and the server authenticated to the beacon. &nbsp;&nbsp;&nbsp; Since then, some stuff has changed and some stuff has been updated. Find the details here. Mainly, things could be done easier if the beacon did away with just a simple shell. So the beacon was changed to perform a GET request to the C2 which would have some response options. You can download a file or upload a file, you can inject a DLL into a process, or you can run a command such as cmd.exe or notepad.exe or calc.exe. Limitless potential! &nbsp;&nbsp;&nbsp; Let&#39;s review the code that&#39;s driving this. The Code DLL Injection&nbsp; &nbsp;&nbsp;&nbsp; DLL injection is somewhat confusing to a lot of people. They can be used to do a lot of things, but the main purpose is to manipulate programs to change how they execute. For example, KeyFarce is a DLL to dump the unlocked contents of a KeePass database. The code used in the beacon for DLL injection was taken from Grayhat Python and slightly adapted for our needs. &nbsp;&nbsp;&nbsp; The only change that we made to the original was that we start a new process and get it&#39;s PID instead of injecting into our own main process. The idea behind this is that if injecting the DLL causes the process to crash, at least our beacon won&#39;t crash. &nbsp;&nbsp;&nbsp; Some may be wondering what these flags set at the start of the function are. More can be found in this Microsoft documentation, but the summary is that PAGE_READWRITE allows us to write to this section of &quot;pages&quot; and pages can be thought of as a virtual section of memory. Then PROCESS_ALL_ACCESS gives you rights to the whole process. Finally, the way the VIRTUAL_MEM flag is set allows us to reserve and commit a space of virtual memory in one go. &nbsp;&nbsp;&nbsp; This function is called with: &nbsp;&nbsp;&nbsp; inject;{dll name}; null Command Execution &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Executing commands on another host is the most basic principle of a beacon. We need this functionality to enumerate the domain, determine our IP, move files around, add users, etc. &nbsp;&nbsp; &nbsp; Subprocess was chosen over Os.System because it executes commands in the context of a new process which makes some detection more challenging. Os.System just forks a new child process for each command making it much easier to trace back the parent calling. This can be seen if you look in your EDR at the execution chain comparing Os.System to subprocess. Os.System can be traced back to Python calling it while subprocess only shows that the command was run. &lt;p&gt;&lt;/p&gt;&lt;p&gt;    The original intent with using subprocess was to use the DETACHED_PROCESS flag which makes our new process not inherit the parents console. The idea was that this would then start a new process which would not have a parent. This can be seen below.&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;    The parent is defined as Non-existent process. Cool right? Using the OS library cannot accomplish anything similar to this as far as I’m aware. The DETACHED_PROCESS flag causes issues though when issuing commands like “ipaddress” or “whoami” so the final version we see here has that removed. &lt;/p&gt;&lt;p&gt;    Below is an example of our beacon running “pwd.” The EDR was able to determine that the process “cmd.exe” had called it with the “/C” flag set, and if we scroll over we can see there is a parent process identifying our beacon.&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;      “pwd” however isn’t an inbuilt tool on Windows. This was downloaded and added to the path. Running something like “whoami” produces very different results.&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;    Unlike with the previous command, there is no parent calling process immediately linked, despite both examples being run the same way. The EDR does give us a parent PID, but we have to query that separately to find out what the parent truly was. To a quick glance, both of the “whoami” being run just look like a standard query being run by the user when one of them was actually run by our beacon.&lt;p&gt;&lt;/p&gt;&lt;p&gt;    This command is called with:&lt;/p&gt;&lt;p&gt;    cmd;{command to run}; null&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;h3 style=&quot;text-align: left;&quot;&gt;File Download &lt;/h3&gt;&lt;p&gt;    Downloading files to a compromised end point is critical. We can add functionality by downloading different DLLs like KeyFarce or we can update the beacon with new features or signatures.&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;    Here, we just do a GET to the URL and then write the contents. We need to include the file extension for when we save it.&lt;/p&gt;&lt;p&gt;    This command is called with:&lt;/p&gt;&lt;p&gt;    download;{url};{file extension} &lt;/p&gt;&lt;h3 style=&quot;text-align: left;&quot;&gt;Uploading Files &lt;/h3&gt;&lt;p&gt;   Exfiltrating information is also a critical function to have. Let’s say you use KeyFarce to dump the KeyPass contents, how are you planning on retrieving that?&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;    With this function, we get a file path and an upload URL, read it in binary format since that allows requests to determine the Content-length header, and then send it off to the URL.&lt;/p&gt;&lt;p&gt;    This command is called with:&lt;/p&gt;&lt;p&gt;     upload;{url};{file to upload]&lt;/p&gt;&lt;h3 style=&quot;text-align: left;&quot;&gt;The Brains&lt;/h3&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;    Finally, the brains of the beacon.&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;     The beacon does a GET to the C2 URL and splits the response on semicolons. There are four options pre built in. Cmd, inject, download, and upload. Each command calls their respective function that we reviewed above. For testing purposes, we are posting to httpbin.org/post which helps illustrate how the data is sent.&lt;p&gt;&lt;/p&gt;&lt;p&gt;    The mTLS is performed in the GET request every time it is used. We just need the client cert, key, and the CA cert file loaded either locally on Linux or into the cert chain on Windows.&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;&lt;/p&gt;&lt;h3 style=&quot;text-align: left;&quot;&gt;Why GET Requests?&lt;/h3&gt;&lt;p style=&quot;text-align: left;&quot;&gt;    A series of GET requests may not be the most graceful way of retrieving commands from our controller, but it does hide itself well among the typical internet traffic you might see. We have changed the user-agent as well to appear more like normal internet traffic, stealing the one FireFox uses. The overall beacon design is very flexible as well. If you don’t care about getting responses back, you can just set up a simple web page for commands to be retrieved from and put Nginx in front of it to keep prying eyes away.&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;h2 style=&quot;text-align: left;&quot;&gt;Final Thoughts&lt;/h2&gt;&lt;p style=&quot;text-align: left;&quot;&gt;    There are some issues that are caused by our use of ctypes here. Microsoft identifies this as malicious right away. Then, a lot of EDR vendors will pickup on the CreateRemoteThread flag that we use heavily in the DLL injection portions. VirtualAllocEx will also stand out to a lot of EDR tools but mainly when you allocate memory with read/write/execute permissions and that’s never a good idea. What we’ve done here is allocate the memory with read/write and then we create a new  thread with an entry point to the LoadLibrary function that then points to our DLL. Despite all this, this goes undetected by a fair amount of vendors on Virustotal which isn’t too surprising to see. SentinelOne, Microsoft, and Elastic are top of the field when it comes to identifying new and emerging threats.&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;&lt;/p&gt;&lt;p style=&quot;text-align: left;&quot;&gt;    Making your own C2 is a lot of fun and there’s a ton of learning that comes with it along the way. You have to address how to hide commands being run, how to exfiltrate information, and how deal with commands being fetched. I had played with Empire and Metasploit previously but had not delved into how they handle multiple compromised endpoints too much, so this was a fun opportunity to solve this problem on my own. There were roadblocks with features that should have been implemented, mainly process injection. It would have been nice to get this implemented but if you’re going to use ctypes that much, you may as well just use C. It wasn’t showcased here either, but handling multiple compromised endpoints is as simple as changing the URL each beacon checks into before compiling into an EXE.&lt;/p&gt;&lt;p&gt;    &lt;/p&gt;&lt;p&gt;&lt;/p&gt;" /><meta property="og:description" content="Intro &nbsp;&nbsp; &nbsp;A while ago I posted about Switchblade. This was a C2 technique that utilized mutual TLS to authenticate beacons that were compromised and separate them out from other traffic. I won&#39;t rehash it too much but it was a cool (in my opinion) way to use Nginx to authenticate beacons with an unusual method and would be considered zero trust since the beacon authenticated to the server and the server authenticated to the beacon. &nbsp;&nbsp;&nbsp; Since then, some stuff has changed and some stuff has been updated. Find the details here. Mainly, things could be done easier if the beacon did away with just a simple shell. So the beacon was changed to perform a GET request to the C2 which would have some response options. You can download a file or upload a file, you can inject a DLL into a process, or you can run a command such as cmd.exe or notepad.exe or calc.exe. Limitless potential! &nbsp;&nbsp;&nbsp; Let&#39;s review the code that&#39;s driving this. The Code DLL Injection&nbsp; &nbsp;&nbsp;&nbsp; DLL injection is somewhat confusing to a lot of people. They can be used to do a lot of things, but the main purpose is to manipulate programs to change how they execute. For example, KeyFarce is a DLL to dump the unlocked contents of a KeePass database. The code used in the beacon for DLL injection was taken from Grayhat Python and slightly adapted for our needs. &nbsp;&nbsp;&nbsp; The only change that we made to the original was that we start a new process and get it&#39;s PID instead of injecting into our own main process. The idea behind this is that if injecting the DLL causes the process to crash, at least our beacon won&#39;t crash. &nbsp;&nbsp;&nbsp; Some may be wondering what these flags set at the start of the function are. More can be found in this Microsoft documentation, but the summary is that PAGE_READWRITE allows us to write to this section of &quot;pages&quot; and pages can be thought of as a virtual section of memory. Then PROCESS_ALL_ACCESS gives you rights to the whole process. Finally, the way the VIRTUAL_MEM flag is set allows us to reserve and commit a space of virtual memory in one go. &nbsp;&nbsp;&nbsp; This function is called with: &nbsp;&nbsp;&nbsp; inject;{dll name}; null Command Execution &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Executing commands on another host is the most basic principle of a beacon. We need this functionality to enumerate the domain, determine our IP, move files around, add users, etc. &nbsp;&nbsp; &nbsp; Subprocess was chosen over Os.System because it executes commands in the context of a new process which makes some detection more challenging. Os.System just forks a new child process for each command making it much easier to trace back the parent calling. This can be seen if you look in your EDR at the execution chain comparing Os.System to subprocess. Os.System can be traced back to Python calling it while subprocess only shows that the command was run. &lt;p&gt;&lt;/p&gt;&lt;p&gt;    The original intent with using subprocess was to use the DETACHED_PROCESS flag which makes our new process not inherit the parents console. The idea was that this would then start a new process which would not have a parent. This can be seen below.&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;    The parent is defined as Non-existent process. Cool right? Using the OS library cannot accomplish anything similar to this as far as I’m aware. The DETACHED_PROCESS flag causes issues though when issuing commands like “ipaddress” or “whoami” so the final version we see here has that removed. &lt;/p&gt;&lt;p&gt;    Below is an example of our beacon running “pwd.” The EDR was able to determine that the process “cmd.exe” had called it with the “/C” flag set, and if we scroll over we can see there is a parent process identifying our beacon.&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;      “pwd” however isn’t an inbuilt tool on Windows. This was downloaded and added to the path. Running something like “whoami” produces very different results.&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;    Unlike with the previous command, there is no parent calling process immediately linked, despite both examples being run the same way. The EDR does give us a parent PID, but we have to query that separately to find out what the parent truly was. To a quick glance, both of the “whoami” being run just look like a standard query being run by the user when one of them was actually run by our beacon.&lt;p&gt;&lt;/p&gt;&lt;p&gt;    This command is called with:&lt;/p&gt;&lt;p&gt;    cmd;{command to run}; null&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;h3 style=&quot;text-align: left;&quot;&gt;File Download &lt;/h3&gt;&lt;p&gt;    Downloading files to a compromised end point is critical. We can add functionality by downloading different DLLs like KeyFarce or we can update the beacon with new features or signatures.&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;    Here, we just do a GET to the URL and then write the contents. We need to include the file extension for when we save it.&lt;/p&gt;&lt;p&gt;    This command is called with:&lt;/p&gt;&lt;p&gt;    download;{url};{file extension} &lt;/p&gt;&lt;h3 style=&quot;text-align: left;&quot;&gt;Uploading Files &lt;/h3&gt;&lt;p&gt;   Exfiltrating information is also a critical function to have. Let’s say you use KeyFarce to dump the KeyPass contents, how are you planning on retrieving that?&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;    With this function, we get a file path and an upload URL, read it in binary format since that allows requests to determine the Content-length header, and then send it off to the URL.&lt;/p&gt;&lt;p&gt;    This command is called with:&lt;/p&gt;&lt;p&gt;     upload;{url};{file to upload]&lt;/p&gt;&lt;h3 style=&quot;text-align: left;&quot;&gt;The Brains&lt;/h3&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;    Finally, the brains of the beacon.&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;     The beacon does a GET to the C2 URL and splits the response on semicolons. There are four options pre built in. Cmd, inject, download, and upload. Each command calls their respective function that we reviewed above. For testing purposes, we are posting to httpbin.org/post which helps illustrate how the data is sent.&lt;p&gt;&lt;/p&gt;&lt;p&gt;    The mTLS is performed in the GET request every time it is used. We just need the client cert, key, and the CA cert file loaded either locally on Linux or into the cert chain on Windows.&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;&lt;/p&gt;&lt;h3 style=&quot;text-align: left;&quot;&gt;Why GET Requests?&lt;/h3&gt;&lt;p style=&quot;text-align: left;&quot;&gt;    A series of GET requests may not be the most graceful way of retrieving commands from our controller, but it does hide itself well among the typical internet traffic you might see. We have changed the user-agent as well to appear more like normal internet traffic, stealing the one FireFox uses. The overall beacon design is very flexible as well. If you don’t care about getting responses back, you can just set up a simple web page for commands to be retrieved from and put Nginx in front of it to keep prying eyes away.&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;h2 style=&quot;text-align: left;&quot;&gt;Final Thoughts&lt;/h2&gt;&lt;p style=&quot;text-align: left;&quot;&gt;    There are some issues that are caused by our use of ctypes here. Microsoft identifies this as malicious right away. Then, a lot of EDR vendors will pickup on the CreateRemoteThread flag that we use heavily in the DLL injection portions. VirtualAllocEx will also stand out to a lot of EDR tools but mainly when you allocate memory with read/write/execute permissions and that’s never a good idea. What we’ve done here is allocate the memory with read/write and then we create a new  thread with an entry point to the LoadLibrary function that then points to our DLL. Despite all this, this goes undetected by a fair amount of vendors on Virustotal which isn’t too surprising to see. SentinelOne, Microsoft, and Elastic are top of the field when it comes to identifying new and emerging threats.&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;&lt;/p&gt;&lt;p style=&quot;text-align: left;&quot;&gt;    Making your own C2 is a lot of fun and there’s a ton of learning that comes with it along the way. You have to address how to hide commands being run, how to exfiltrate information, and how deal with commands being fetched. I had played with Empire and Metasploit previously but had not delved into how they handle multiple compromised endpoints too much, so this was a fun opportunity to solve this problem on my own. There were roadblocks with features that should have been implemented, mainly process injection. It would have been nice to get this implemented but if you’re going to use ctypes that much, you may as well just use C. It wasn’t showcased here either, but handling multiple compromised endpoints is as simple as changing the URL each beacon checks into before compiling into an EXE.&lt;/p&gt;&lt;p&gt;    &lt;/p&gt;&lt;p&gt;&lt;/p&gt;" /><link rel="canonical" href="/posts/switchblade-to-swiss-army-knife-adding/" /><meta property="og:url" content="/posts/switchblade-to-swiss-army-knife-adding/" /><meta property="og:site_name" content="Culbert Report" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-04-25T17:41:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Switchblade To Swiss Army Knife: Expanding The Toolset With Python" /><meta name="twitter:site" content="@mattculbert" /><meta name="twitter:creator" content="@Matt C" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Matt C"},"dateModified":"2022-09-06T19:34:41+00:00","datePublished":"2022-04-25T17:41:00+00:00","description":"Intro &nbsp;&nbsp; &nbsp;A while ago I posted about Switchblade. This was a C2 technique that utilized mutual TLS to authenticate beacons that were compromised and separate them out from other traffic. I won&#39;t rehash it too much but it was a cool (in my opinion) way to use Nginx to authenticate beacons with an unusual method and would be considered zero trust since the beacon authenticated to the server and the server authenticated to the beacon. &nbsp;&nbsp;&nbsp; Since then, some stuff has changed and some stuff has been updated. Find the details here. Mainly, things could be done easier if the beacon did away with just a simple shell. So the beacon was changed to perform a GET request to the C2 which would have some response options. You can download a file or upload a file, you can inject a DLL into a process, or you can run a command such as cmd.exe or notepad.exe or calc.exe. Limitless potential! &nbsp;&nbsp;&nbsp; Let&#39;s review the code that&#39;s driving this. The Code DLL Injection&nbsp; &nbsp;&nbsp;&nbsp; DLL injection is somewhat confusing to a lot of people. They can be used to do a lot of things, but the main purpose is to manipulate programs to change how they execute. For example, KeyFarce is a DLL to dump the unlocked contents of a KeePass database. The code used in the beacon for DLL injection was taken from Grayhat Python and slightly adapted for our needs. &nbsp;&nbsp;&nbsp; The only change that we made to the original was that we start a new process and get it&#39;s PID instead of injecting into our own main process. The idea behind this is that if injecting the DLL causes the process to crash, at least our beacon won&#39;t crash. &nbsp;&nbsp;&nbsp; Some may be wondering what these flags set at the start of the function are. More can be found in this Microsoft documentation, but the summary is that PAGE_READWRITE allows us to write to this section of &quot;pages&quot; and pages can be thought of as a virtual section of memory. Then PROCESS_ALL_ACCESS gives you rights to the whole process. Finally, the way the VIRTUAL_MEM flag is set allows us to reserve and commit a space of virtual memory in one go. &nbsp;&nbsp;&nbsp; This function is called with: &nbsp;&nbsp;&nbsp; inject;{dll name}; null Command Execution &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Executing commands on another host is the most basic principle of a beacon. We need this functionality to enumerate the domain, determine our IP, move files around, add users, etc. &nbsp;&nbsp; &nbsp; Subprocess was chosen over Os.System because it executes commands in the context of a new process which makes some detection more challenging. Os.System just forks a new child process for each command making it much easier to trace back the parent calling. This can be seen if you look in your EDR at the execution chain comparing Os.System to subprocess. Os.System can be traced back to Python calling it while subprocess only shows that the command was run. &lt;p&gt;&lt;/p&gt;&lt;p&gt;    The original intent with using subprocess was to use the DETACHED_PROCESS flag which makes our new process not inherit the parents console. The idea was that this would then start a new process which would not have a parent. This can be seen below.&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;    The parent is defined as Non-existent process. Cool right? Using the OS library cannot accomplish anything similar to this as far as I’m aware. The DETACHED_PROCESS flag causes issues though when issuing commands like “ipaddress” or “whoami” so the final version we see here has that removed. &lt;/p&gt;&lt;p&gt;    Below is an example of our beacon running “pwd.” The EDR was able to determine that the process “cmd.exe” had called it with the “/C” flag set, and if we scroll over we can see there is a parent process identifying our beacon.&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;      “pwd” however isn’t an inbuilt tool on Windows. This was downloaded and added to the path. Running something like “whoami” produces very different results.&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;    Unlike with the previous command, there is no parent calling process immediately linked, despite both examples being run the same way. The EDR does give us a parent PID, but we have to query that separately to find out what the parent truly was. To a quick glance, both of the “whoami” being run just look like a standard query being run by the user when one of them was actually run by our beacon.&lt;p&gt;&lt;/p&gt;&lt;p&gt;    This command is called with:&lt;/p&gt;&lt;p&gt;    cmd;{command to run}; null&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;h3 style=&quot;text-align: left;&quot;&gt;File Download &lt;/h3&gt;&lt;p&gt;    Downloading files to a compromised end point is critical. We can add functionality by downloading different DLLs like KeyFarce or we can update the beacon with new features or signatures.&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;    Here, we just do a GET to the URL and then write the contents. We need to include the file extension for when we save it.&lt;/p&gt;&lt;p&gt;    This command is called with:&lt;/p&gt;&lt;p&gt;    download;{url};{file extension} &lt;/p&gt;&lt;h3 style=&quot;text-align: left;&quot;&gt;Uploading Files &lt;/h3&gt;&lt;p&gt;   Exfiltrating information is also a critical function to have. Let’s say you use KeyFarce to dump the KeyPass contents, how are you planning on retrieving that?&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;    With this function, we get a file path and an upload URL, read it in binary format since that allows requests to determine the Content-length header, and then send it off to the URL.&lt;/p&gt;&lt;p&gt;    This command is called with:&lt;/p&gt;&lt;p&gt;     upload;{url};{file to upload]&lt;/p&gt;&lt;h3 style=&quot;text-align: left;&quot;&gt;The Brains&lt;/h3&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;    Finally, the brains of the beacon.&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;     The beacon does a GET to the C2 URL and splits the response on semicolons. There are four options pre built in. Cmd, inject, download, and upload. Each command calls their respective function that we reviewed above. For testing purposes, we are posting to httpbin.org/post which helps illustrate how the data is sent.&lt;p&gt;&lt;/p&gt;&lt;p&gt;    The mTLS is performed in the GET request every time it is used. We just need the client cert, key, and the CA cert file loaded either locally on Linux or into the cert chain on Windows.&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;&lt;/p&gt;&lt;h3 style=&quot;text-align: left;&quot;&gt;Why GET Requests?&lt;/h3&gt;&lt;p style=&quot;text-align: left;&quot;&gt;    A series of GET requests may not be the most graceful way of retrieving commands from our controller, but it does hide itself well among the typical internet traffic you might see. We have changed the user-agent as well to appear more like normal internet traffic, stealing the one FireFox uses. The overall beacon design is very flexible as well. If you don’t care about getting responses back, you can just set up a simple web page for commands to be retrieved from and put Nginx in front of it to keep prying eyes away.&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;h2 style=&quot;text-align: left;&quot;&gt;Final Thoughts&lt;/h2&gt;&lt;p style=&quot;text-align: left;&quot;&gt;    There are some issues that are caused by our use of ctypes here. Microsoft identifies this as malicious right away. Then, a lot of EDR vendors will pickup on the CreateRemoteThread flag that we use heavily in the DLL injection portions. VirtualAllocEx will also stand out to a lot of EDR tools but mainly when you allocate memory with read/write/execute permissions and that’s never a good idea. What we’ve done here is allocate the memory with read/write and then we create a new  thread with an entry point to the LoadLibrary function that then points to our DLL. Despite all this, this goes undetected by a fair amount of vendors on Virustotal which isn’t too surprising to see. SentinelOne, Microsoft, and Elastic are top of the field when it comes to identifying new and emerging threats.&lt;/p&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;p&gt;&lt;/p&gt;&lt;p style=&quot;text-align: left;&quot;&gt;    Making your own C2 is a lot of fun and there’s a ton of learning that comes with it along the way. You have to address how to hide commands being run, how to exfiltrate information, and how deal with commands being fetched. I had played with Empire and Metasploit previously but had not delved into how they handle multiple compromised endpoints too much, so this was a fun opportunity to solve this problem on my own. There were roadblocks with features that should have been implemented, mainly process injection. It would have been nice to get this implemented but if you’re going to use ctypes that much, you may as well just use C. It wasn’t showcased here either, but handling multiple compromised endpoints is as simple as changing the URL each beacon checks into before compiling into an EXE.&lt;/p&gt;&lt;p&gt;    &lt;/p&gt;&lt;p&gt;&lt;/p&gt;","headline":"Switchblade To Swiss Army Knife: Expanding The Toolset With Python","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/switchblade-to-swiss-army-knife-adding/"},"url":"/posts/switchblade-to-swiss-army-knife-adding/"}</script><title>Switchblade To Swiss Army Knife: Expanding The Toolset With Python | Culbert Report</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Culbert Report"><meta name="application-name" content="Culbert Report"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/thumb.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Culbert Report</a></div><div class="site-subtitle font-italic">Get in loser, we're hating AI and bringing back real learning. Site art by Kenton Drumm</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/matt-culbert" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/mattculbert" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['matt','culbertreport.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Switchblade To Swiss Army Knife: Expanding The Toolset With Python</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Switchblade To Swiss Army Knife: Expanding The Toolset With Python</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1650908460" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Apr 25, 2022 </em> </span> <span> Updated <em class="" data-ts="1662492881" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 6, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href=""></a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1341 words"> <em>7 min</em> read</span></div></div></div><div class="post-content"><h2 style="text-align: left;"><span><span>Intro <br /></span></span></h2><p><span><span>&nbsp;&nbsp; &nbsp;</span>A while ago I posted about Switchblade. This was a C2 technique that utilized mutual TLS to authenticate beacons that were compromised and separate them out from other traffic. I won't rehash it too much but it was a cool (in my opinion) way to use Nginx to authenticate beacons with an unusual method and would be considered zero trust since the beacon authenticated to the server and the server authenticated to the beacon.</span></p><p><span><span>&nbsp;&nbsp;&nbsp; </span>Since then, some stuff has changed and some stuff has been updated.<a href="https://github.com/matt-culbert/Switchblade/blob/main/beacon.py" rel="nofollow" target="_blank"> Find the details here</a>. Mainly, things could be done easier if the beacon did away with just a simple shell. So the beacon was changed to perform a GET request to the C2 which would have some response options. You can download a file or upload a file, you can inject a DLL into a process, or you can run a command such as cmd.exe or notepad.exe or calc.exe. Limitless potential!<br /></span></p><p><span></span><span></span></p><div class="separator" style="clear: both; text-align: center;"><span><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhtTxvaZh8tPYrtRls10jOyrel6k-mQDfkGPW7GIe7dYp6Z-5oeUA-xP_sIwKtxG3vwzYQDPfVk72oNNyQrI8rK_gtY_JWDkmBbIOG_hI01jHR_nSU-lWRyvBEzWwC9ZmLrni_qn28gW7tp_-6BybDu_LxQ1HOxpRepkKt2BIvOQ5cFGkS33EZCv1gJ1A/s625/fully%20usable%20beacon.png" style="margin-left: 1em; margin-right: 1em;" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 607 159'%3E%3C/svg%3E" border="0" data-original-height="164" data-original-width="625" height="159" data-src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhtTxvaZh8tPYrtRls10jOyrel6k-mQDfkGPW7GIe7dYp6Z-5oeUA-xP_sIwKtxG3vwzYQDPfVk72oNNyQrI8rK_gtY_JWDkmBbIOG_hI01jHR_nSU-lWRyvBEzWwC9ZmLrni_qn28gW7tp_-6BybDu_LxQ1HOxpRepkKt2BIvOQ5cFGkS33EZCv1gJ1A/w607-h159/fully%20usable%20beacon.png" width="607" class="lazyload" data-proofer-ignore></a></span></div><p><span><span>&nbsp;<span>&nbsp;&nbsp; </span>Let's review the code that's driving this.</span></span></p><h2 style="text-align: left;"><span><span><span>The Code </span></span></span></h2><h3 style="text-align: left;"><span><span><span>DLL Injection</span></span></span><span><span><span>&nbsp; <br /></span></span></span></h3><p><span><span><span><span><span>&nbsp;&nbsp;&nbsp; </span>DLL injection is somewhat confusing to a lot of people. They can be used to do a lot of things, but the main purpose is to manipulate programs to change how they execute. For example, KeyFarce is a DLL to dump the unlocked contents of a KeePass database. The code used in the beacon for DLL injection was taken from</span></span></span></span><span><span><span><span><span><span> Grayhat Python and slightly adapted for our needs.</span></span> </span></span></span></span></p><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjw-b_9hVVZnWSxpj11g0bgFSycIRMaWkVjgz01oC2qe40i4LlYG8rbrZcJxFV4N1gf8GhAqGeb8YNV54OWCWYnpx9uum6_lYQ8LmYsE2X-nPFn9TxlOlqaig7Ep0qk0DkxE9TO1xBmFkWkvmWQyMGHTR4GABCkyKdK1wtiJYzsYPd_pdzQ28Bthc9X9Q/s836/dll_injection.png" style="margin-left: 1em; margin-right: 1em;" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 598 549'%3E%3C/svg%3E" border="0" data-original-height="769" data-original-width="836" height="549" data-src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjw-b_9hVVZnWSxpj11g0bgFSycIRMaWkVjgz01oC2qe40i4LlYG8rbrZcJxFV4N1gf8GhAqGeb8YNV54OWCWYnpx9uum6_lYQ8LmYsE2X-nPFn9TxlOlqaig7Ep0qk0DkxE9TO1xBmFkWkvmWQyMGHTR4GABCkyKdK1wtiJYzsYPd_pdzQ28Bthc9X9Q/w598-h549/dll_injection.png" width="598" class="lazyload" data-proofer-ignore></a></div><p><span><span><br /> </span><span>&nbsp;&nbsp;&nbsp; </span>The only change that we made to the original was that we start a new process and get it's PID instead of injecting into our own main process. The idea behind this is that if injecting the DLL causes the process to crash, at least our beacon won't crash.</span></p><p><span><span>&nbsp;&nbsp;&nbsp; </span>Some may be wondering what these flags set at the start of the function are. More can be found in <a href="https://docs.microsoft.com/en-us/windows/win32/memory/memory-protection-constants" rel="nofollow" target="_blank">this Microsoft documentation</a>, but the summary is that PAGE_READWRITE allows us to write to this section of "pages" and pages can be thought of as a virtual section of memory. Then PROCESS_ALL_ACCESS gives you rights to the whole process. Finally, the way the VIRTUAL_MEM flag is set allows us to reserve and commit a space of virtual memory in one go.</span></p><p><span><span>&nbsp;&nbsp;&nbsp; </span>This function is called with:</span></p><p><span><span>&nbsp;&nbsp;&nbsp; </span><span style="font-family: courier;">inject;{dll name}; null</span><br /></span></p><h3 style="text-align: left;"><span>Command Execution<br /></span></h3><p><span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span><span>&nbsp;&nbsp;&nbsp; </span>Executing commands on another host is the most basic principle of a beacon. We need this functionality to enumerate the domain, determine our IP, move files around, add users, etc.</span></p><p><span></span></p><div class="separator" style="clear: both; text-align: center;"><span><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhCfEy_AFSHhw-O0ME79nBWX4CplgP7MknHqB_Lk-jHPoKvmoRmLwPJlBGmKSFT6CGrNE1RX9qel7R-xryFcaVY9js5cbP29MNKC0I7tXGUiO05U0XjdOAyPCcvEU_--h3z-GX6lZaQXGPxRJcOSWdur46tPSK3auLbhd8pTrY2dRfE7Al7dUCP0v8OjA/s936/cmdexe.png" style="margin-left: 1em; margin-right: 1em;" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 605 155'%3E%3C/svg%3E" border="0" data-original-height="241" data-original-width="936" height="155" data-src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhCfEy_AFSHhw-O0ME79nBWX4CplgP7MknHqB_Lk-jHPoKvmoRmLwPJlBGmKSFT6CGrNE1RX9qel7R-xryFcaVY9js5cbP29MNKC0I7tXGUiO05U0XjdOAyPCcvEU_--h3z-GX6lZaQXGPxRJcOSWdur46tPSK3auLbhd8pTrY2dRfE7Al7dUCP0v8OjA/w605-h155/cmdexe.png" width="605" class="lazyload" data-proofer-ignore></a></span></div><p></p><p><span><span><span>&nbsp;&nbsp; &nbsp;</span></span></span><span><span><span> Subprocess was chosen over Os.System because it executes commands in the context of a new process which makes some detection more challenging. Os.System just forks a new child process for each command making it much easier to trace back the parent calling. This can be seen if you look in your EDR at the execution chain comparing Os.System to subprocess. Os.System can be traced back to Python calling it while subprocess only shows that the command was run.</span></span></span></p><div class="separator" style="clear: both; text-align: center;"><span><span><span><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEivSgLPCQxJxzRw0MklckZ5itkfdfFoVexDLIuSRK_6ZySVvxIOJUh9hSLjkLeD6dBH10XMfmSLL6kmZ-z5S3bqLQlW3dpZdocuFXEQFUqd5EphwRRUXsxPq9h6Uw4h70W0dMqwEkBRDCXjBdlxwb4Pft6NeRAk3p_iH1wwpY5e4t1ywpjfHXt0sPMhrg/s703/ossystem-compare.png" style="margin-left: 1em; margin-right: 1em;" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 712 118'%3E%3C/svg%3E" border="0" data-original-height="117" data-original-width="703" height="118" data-src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEivSgLPCQxJxzRw0MklckZ5itkfdfFoVexDLIuSRK_6ZySVvxIOJUh9hSLjkLeD6dBH10XMfmSLL6kmZ-z5S3bqLQlW3dpZdocuFXEQFUqd5EphwRRUXsxPq9h6Uw4h70W0dMqwEkBRDCXjBdlxwb4Pft6NeRAk3p_iH1wwpY5e4t1ywpjfHXt0sPMhrg/w712-h118/ossystem-compare.png" width="712" class="lazyload" data-proofer-ignore></a></span></span></span></div><span><span></span></span><p></p><p><span><span><span>&nbsp;&nbsp; &nbsp;</span>The original intent with using subprocess was to use the DETACHED_PROCESS flag which makes our new process not inherit the parents console. The idea was that this would then start a new process which would not have a parent. This can be seen below.</span></span></p><div class="separator" style="clear: both; text-align: center;"><span><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjMYykzZdoohp5jmRAseaCPJH7KcRX9PQX7FFIrJ8IA8t54SOILvgXRiVcL5Sh865xAS-jgU585JE2rETBA6YqDgCp-IV25nCPNiybr4swY-DNB3wf34h9rATRDZ4XTcrTZP2Rdabnzf49Ws2yi6q0cAPXNSJEkftxk_wgBeSexSwV69AZ95qjon5rr4w/s574/no%20parent%20process.png" style="margin-left: 1em; margin-right: 1em;" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 401 515'%3E%3C/svg%3E" border="0" data-original-height="574" data-original-width="446" height="515" data-src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjMYykzZdoohp5jmRAseaCPJH7KcRX9PQX7FFIrJ8IA8t54SOILvgXRiVcL5Sh865xAS-jgU585JE2rETBA6YqDgCp-IV25nCPNiybr4swY-DNB3wf34h9rATRDZ4XTcrTZP2Rdabnzf49Ws2yi6q0cAPXNSJEkftxk_wgBeSexSwV69AZ95qjon5rr4w/w401-h515/no%20parent%20process.png" width="401" class="lazyload" data-proofer-ignore></a></span></div><span><span></span></span><p></p><p><span><span><span>&nbsp;&nbsp; &nbsp;</span>The parent is defined as Non-existent process. Cool right? Using the OS library cannot accomplish anything similar to this as far as I'm aware. The DETACHED_PROCESS flag causes issues though when issuing commands like "ipaddress" or "whoami" so the final version we see here has that removed.&nbsp;</span></span></p><p><span><span><span>&nbsp;&nbsp;&nbsp; </span>Below is an example of our beacon running "pwd." The EDR was able to determine that the process "cmd.exe" had called it with the "/C" flag set, and if we scroll over we can see there is a parent process identifying our beacon.</span></span></p><p><span><span></span></span></p><div class="separator" style="clear: both; text-align: center;"><span><span></span></span></div><div class="separator" style="clear: both; text-align: center;"><span><span></span></span></div><div class="separator" style="clear: both; text-align: center;"><span><span><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgGazQsTvv5Jg0IqEV2P5chTdBdJkkybFOZuQNr5kzjRM3NVLoWGBD5p1FRM-Wxa5sSGxjBqZYon6H-75XM8cdr9deX6F0DiMaVcOpYC-Id67H3pRWZ5kNMX1Q5z4kw4BNPrQwEl-MUl6pSmAL9ZjkSu6Cz9MD-hAvS9qw1FhHFQmCIjmsUU2bBQsb05w/s1091/pwd_trace.png" style="margin-left: 1em; margin-right: 1em;" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 763 76'%3E%3C/svg%3E" border="0" data-original-height="108" data-original-width="1091" height="76" data-src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgGazQsTvv5Jg0IqEV2P5chTdBdJkkybFOZuQNr5kzjRM3NVLoWGBD5p1FRM-Wxa5sSGxjBqZYon6H-75XM8cdr9deX6F0DiMaVcOpYC-Id67H3pRWZ5kNMX1Q5z4kw4BNPrQwEl-MUl6pSmAL9ZjkSu6Cz9MD-hAvS9qw1FhHFQmCIjmsUU2bBQsb05w/w763-h76/pwd_trace.png" width="763" class="lazyload" data-proofer-ignore></a></span></span></div><p><span><span><span>&nbsp; <span>&nbsp;&nbsp;&nbsp; </span>"pwd" however isn't an inbuilt tool on Windows. This was downloaded and added to the path. Running something like "whoami" produces very different results.</span></span></span></p><p><span><span><span></span></span></span></p><div class="separator" style="clear: both; text-align: center;"><span><span><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjKRJH8wrZI02q1jElouYkRrwU4gP0iOhQjHTTvAzg-IYgC5s32uABgUmsOJ5AkURCcDEkISxVdBhkNeAugtBTkTuGf_Qk2UXxPS7RfICIXCM-xysqYsKR6bAm5M9ZVGeKFgihsoB7suuTCOvNW2O1j-x8Abx9qeUvc8IDvhmrRjlXJMhgGasx7hvd6Sg/s1350/whoami_trace.png" style="margin-left: 1em; margin-right: 1em;" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 919 291'%3E%3C/svg%3E" border="0" data-original-height="424" data-original-width="1350" height="291" data-src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjKRJH8wrZI02q1jElouYkRrwU4gP0iOhQjHTTvAzg-IYgC5s32uABgUmsOJ5AkURCcDEkISxVdBhkNeAugtBTkTuGf_Qk2UXxPS7RfICIXCM-xysqYsKR6bAm5M9ZVGeKFgihsoB7suuTCOvNW2O1j-x8Abx9qeUvc8IDvhmrRjlXJMhgGasx7hvd6Sg/w919-h291/whoami_trace.png" width="919" class="lazyload" data-proofer-ignore></a></span></span></div><span><span><br /><span>&nbsp;&nbsp;&nbsp; </span>Unlike with the previous command, there is no parent calling process immediately linked, despite both examples being run the same way. The EDR does give us a parent PID, but we have to query that separately to find out what the parent truly was. To a quick glance, both of the "whoami" being run just look like a standard query being run by the user when one of them was actually run by our beacon.</span></span><p></p><p><span><span><span><span>&nbsp;&nbsp;&nbsp; </span>This command is called with:</span></span></span></p><p><span><span><span><span>&nbsp;&nbsp;&nbsp; </span><span style="font-family: courier;">cmd;{command to run}; null</span><br /></span></span></span></p><p></p><h3 style="text-align: left;"><span>File Download <br /></span></h3><p><span><span>&nbsp;&nbsp;&nbsp; </span>Downloading files to a compromised end point is critical. We can add functionality by downloading different DLLs like KeyFarce or we can update the beacon with new features or signatures.</span></p><p><span></span></p><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><span><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhRAEeAFT0DApCdMdX5RcveUi93uD0yYQqWEL4EraNykppbfCR4ScWqJFUarOZD3N03HybCmV16KbDrQw7h8Rqp0IjmbjOlRWosuvwe9ThR8jSCjJTGmONsF-qyHi6FY-7LglMGm2_aLCB_j3v0HXxAR5PQu0IUzKNpgbLguw9Byjy1fyE9ATxGgtwWfw/s536/downloader.png" style="margin-left: 1em; margin-right: 1em;" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 481 149'%3E%3C/svg%3E" border="0" data-original-height="165" data-original-width="536" height="149" data-src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhRAEeAFT0DApCdMdX5RcveUi93uD0yYQqWEL4EraNykppbfCR4ScWqJFUarOZD3N03HybCmV16KbDrQw7h8Rqp0IjmbjOlRWosuvwe9ThR8jSCjJTGmONsF-qyHi6FY-7LglMGm2_aLCB_j3v0HXxAR5PQu0IUzKNpgbLguw9Byjy1fyE9ATxGgtwWfw/w481-h149/downloader.png" width="481" class="lazyload" data-proofer-ignore></a></span><br /></div><p><span><span>&nbsp;&nbsp;&nbsp; </span>Here, we just do a GET to the URL and then write the contents. We need to include the file extension for when we save it.</span></p><p><span><span>&nbsp;&nbsp;&nbsp; </span>This command is called with:</span></p><p><span><span>&nbsp;&nbsp; &nbsp;</span><span style="font-family: courier;">download;{url};{file extension}</span> <br /></span></p><h3 style="text-align: left;"><span>Uploading Files <br /></span></h3><p><span><span>&nbsp;&nbsp; Exfiltrating information is also a critical function to have. Let's say you use KeyFarce to dump the KeyPass contents, how are you planning on retrieving that?</span></span></p><div class="separator" style="clear: both; text-align: center;"></div><p></p><p><span></span></p><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><span><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjFyQbYj-0QzEvFrJQt5Qqb9mnktCYiHAh2BnB0jKk0_3oWcjNLzeNL2Ut9GOxuJnHO-gj5gxmmLIDPjDIlnTRGjIcOikuIOYDSSZMnyjamSZVSR7khD7zxXWZ--I5lDPFom6EsEoV5cFpbz_8zUoQ7ggAxB4QACT22Gtg5hcgCPiuEif3ZJ4n7JaGfOw/s558/upload.png" style="margin-left: 1em; margin-right: 1em;" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 494 142'%3E%3C/svg%3E" border="0" data-original-height="161" data-original-width="558" height="142" data-src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjFyQbYj-0QzEvFrJQt5Qqb9mnktCYiHAh2BnB0jKk0_3oWcjNLzeNL2Ut9GOxuJnHO-gj5gxmmLIDPjDIlnTRGjIcOikuIOYDSSZMnyjamSZVSR7khD7zxXWZ--I5lDPFom6EsEoV5cFpbz_8zUoQ7ggAxB4QACT22Gtg5hcgCPiuEif3ZJ4n7JaGfOw/w494-h142/upload.png" width="494" class="lazyload" data-proofer-ignore></a></span></div><p><span><span>&nbsp;&nbsp; &nbsp;</span>With this function, we get a file path and an upload URL, read it in binary format since that allows requests to determine the Content-length header, and then send it off to the URL.</span></p><p><span><span>&nbsp;&nbsp;&nbsp; </span>This command is called with:</span></p><p><span><span>&nbsp;&nbsp; &nbsp;</span> <span style="font-family: courier;">upload;{url};{file to upload]</span><br /></span></p><h3 style="text-align: left;"><span><span>The Brains<br /></span></span></h3><p></p><p></p><p><span><span>&nbsp;&nbsp;&nbsp; </span>Finally, the brains of the beacon.</span></p><p><span></span></p><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiKb-sBym6PWigOp_loB_s-oabmbdJD1Ld446xm7ctEPktnT37VmChhD1a9r6SU9khu3zUwC--OPXkeIjnGWVh2Z6UX2gxdKZ9bCRGzhmXDInajOWivwKxH7GxYOAjT-J7bePS3WAP7gsM5B-dAvPaKnuCs6VVxXIjQA2ZWXl7eSvSZk80koUYmU6fJ7A/s872/while_loop.png" style="margin-left: 1em; margin-right: 1em;" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 518 287'%3E%3C/svg%3E" border="0" data-original-height="482" data-original-width="872" height="287" data-src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiKb-sBym6PWigOp_loB_s-oabmbdJD1Ld446xm7ctEPktnT37VmChhD1a9r6SU9khu3zUwC--OPXkeIjnGWVh2Z6UX2gxdKZ9bCRGzhmXDInajOWivwKxH7GxYOAjT-J7bePS3WAP7gsM5B-dAvPaKnuCs6VVxXIjQA2ZWXl7eSvSZk80koUYmU6fJ7A/w518-h287/while_loop.png" width="518" class="lazyload" data-proofer-ignore></a></div><span><br /> <span>&nbsp;&nbsp;&nbsp; </span>The beacon does a GET to the C2 URL and splits the response on semicolons. There are four options pre built in. Cmd, inject, download, and upload. Each command calls their respective function that we reviewed above. For testing purposes, we are posting to httpbin.org/post which helps illustrate how the data is sent.</span><p></p><p><span><span>&nbsp;&nbsp;&nbsp; The mTLS is performed in the GET request every time it is used. We just need the client cert, key, and the CA cert file loaded either locally on Linux or into the cert chain on Windows.<br /></span></span></p><div class="separator" style="clear: both; text-align: center;"><span><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEinZaLv3DMg7ZzBCv7Tjub9wE5f9xQBbkz9qxwwlLTuRXsepNo6JsWETUfGkPB7IS8xdjdPlxfOVHliNxW7qCdN16kVVIRWxg6dxlUubAvrvTiqZr08BUxTCFawZXE5tycl6qAOAXqWQy5PEzTGru3mFl150weym4qALzSoHaJtMW6RmgSOJHPhje5Nkw/s844/mTLS.png" style="margin-left: 1em; margin-right: 1em;" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 737 23'%3E%3C/svg%3E" border="0" data-original-height="26" data-original-width="844" height="23" data-src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEinZaLv3DMg7ZzBCv7Tjub9wE5f9xQBbkz9qxwwlLTuRXsepNo6JsWETUfGkPB7IS8xdjdPlxfOVHliNxW7qCdN16kVVIRWxg6dxlUubAvrvTiqZr08BUxTCFawZXE5tycl6qAOAXqWQy5PEzTGru3mFl150weym4qALzSoHaJtMW6RmgSOJHPhje5Nkw/w737-h23/mTLS.png" width="737" class="lazyload" data-proofer-ignore></a></span></div><p><span></span></p><h3 style="text-align: left;"><span>Why GET Requests?</span></h3><p style="text-align: left;"><span><span>&nbsp;&nbsp;&nbsp; </span>A series of GET requests may not be the most graceful way of retrieving commands from our controller, but it does hide itself well among the typical internet traffic you might see. We have changed the user-agent as well to appear more like normal internet traffic, stealing the one FireFox uses. The overall beacon design is very flexible as well. If you don't care about getting responses back, you can just set up a simple web page for commands to be retrieved from and put Nginx in front of it to keep prying eyes away.<br /></span></p><p></p><h2 style="text-align: left;">Final Thoughts</h2><p style="text-align: left;"><span>&nbsp;&nbsp;&nbsp; </span>There are some issues that are caused by our use of ctypes here. Microsoft identifies this as malicious right away. Then, a lot of EDR vendors will pickup on the CreateRemoteThread flag that we use heavily in the DLL injection portions. VirtualAllocEx will also stand out to a lot of EDR tools but mainly when you allocate memory with read/write/execute permissions and that's never a good idea. What we've done here is allocate the memory with read/write and then we create a new&nbsp; thread with an entry point to the LoadLibrary function that then points to our DLL. Despite all this, this goes undetected by a fair amount of vendors on Virustotal which isn't too surprising to see. SentinelOne, Microsoft, and Elastic are top of the field when it comes to identifying new and emerging threats.<br /></p><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEipYArzpHTKcDqZoTU1I1_4mrnGjJr4mxiJCjJTHA3iObrVUbA9fmxQEpxqPErUvS3f6vHqtL8XQQbMx4xmuGElZN4QdjQ_wJY4TuuNNuQxLQIOQkumqopAHKsY6q1mQYESTWYuXqLhqPQn1PRWzV2KyB5d4R_22ECBaHCn-VZSPO6iWG16MM7mvhHaJw/s1329/detections.png" style="margin-left: 1em; margin-right: 1em;" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 870 332'%3E%3C/svg%3E" border="0" data-original-height="505" data-original-width="1329" height="332" data-src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEipYArzpHTKcDqZoTU1I1_4mrnGjJr4mxiJCjJTHA3iObrVUbA9fmxQEpxqPErUvS3f6vHqtL8XQQbMx4xmuGElZN4QdjQ_wJY4TuuNNuQxLQIOQkumqopAHKsY6q1mQYESTWYuXqLhqPQn1PRWzV2KyB5d4R_22ECBaHCn-VZSPO6iWG16MM7mvhHaJw/w870-h332/detections.png" width="870" class="lazyload" data-proofer-ignore></a></div><br /><br /><p></p><p style="text-align: left;"><span>&nbsp;&nbsp;&nbsp; Making your own C2 is a lot of fun and there's a ton of learning that comes with it along the way. You have to address how to hide commands being run, how to exfiltrate information, and how deal with commands being fetched. I had played with Empire and Metasploit previously but had not delved into how they handle multiple compromised endpoints too much, so this was a fun opportunity to solve this problem on my own. There were roadblocks with features that should have been implemented, mainly process injection. It would have been nice to get this implemented but if you're going to use ctypes that much, you may as well just use C. It wasn't showcased here either, but handling multiple compromised endpoints is as simple as changing the URL each beacon checks into before compiling into an EXE.<br /></span></p><p><span><span>&nbsp;&nbsp; &nbsp;</span><br /></span></p><p></p></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Switchblade%20To%20Swiss%20Army%20Knife:%20Expanding%20The%20Toolset%20With%20Python%20-%20Culbert%20Report&url=%2Fposts%2Fswitchblade-to-swiss-army-knife-adding%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Switchblade%20To%20Swiss%20Army%20Knife:%20Expanding%20The%20Toolset%20With%20Python%20-%20Culbert%20Report&u=%2Fposts%2Fswitchblade-to-swiss-army-knife-adding%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Fswitchblade-to-swiss-army-knife-adding%2F&text=Switchblade%20To%20Swiss%20Army%20Knife:%20Expanding%20The%20Toolset%20With%20Python%20-%20Culbert%20Report" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Making-Red-Teaming-Safer/">Making Red Teaming Safer</a><li><a href="/posts/Human-Learning-Is-Irreplaceable/">Human Learning Is Irreplaceable</a><li><a href="/posts/Building-A-Detection-Lab-Around-Suricata/">Building A Detection Lab Around Suricata</a><li><a href="/posts/The-evolution-of-evasion/">The Evolution Of Evasion</a><li><a href="/posts/C2-Smackdown-Empire-vs-Mythic/">C2 Smackdown Empire Vs Mythic</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/redteam/">redteam</a> <a class="post-tag" href="/tags/c2/">c2</a> <a class="post-tag" href="/tags/container/">container</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/graphana/">graphana</a> <a class="post-tag" href="/tags/jira/">jira</a> <a class="post-tag" href="/tags/nessus/">nessus</a> <a class="post-tag" href="/tags/non-technical/">non-technical</a> <a class="post-tag" href="/tags/nuages/">nuages</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/We-have-lost-the-plot-with-LLMs/"><div class="card-body"> <em class="small" data-ts="1771804800" data-df="ll" > Feb 23, 2026 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>We Have Lost The Plot With Llms</h3><div class="text-muted small"><p> We’ve collectively lost the plot In IT and security we say that users are the weakest link, but this is no longer true; now, the weakest link is whatever LLM your company is using to act as both a ...</p></div></div></a></div><div class="card"> <a href="/posts/Language-models-cannot-make-art/"><div class="card-body"> <em class="small" data-ts="1770249600" data-df="ll" > Feb 5, 2026 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Language Models Cannot Make Art</h3><div class="text-muted small"><p> I was in a random coffee shop a few months back and I noticed that they had little “coffee table” books for sale. One that caught my eye was a Japanese color combination dictionary, originally prin...</p></div></div></a></div><div class="card"> <a href="/posts/Human-Learning-Is-Irreplaceable/"><div class="card-body"> <em class="small" data-ts="1759881600" data-df="ll" > Oct 8, 2025 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Human Learning Is Irreplaceable</h3><div class="text-muted small"><p> What we call “AI” is really just a cancer attacking our ability to learn and we have very little time remaining to carve it out. A note When I began writing this, it was June in Vermont and one ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/sometimes-projects-dont-pan-out/" class="btn btn-outline-primary" prompt="Older"><p>Sometimes Projects Don't Pan Out</p></a> <a href="/posts/hiding-in-alternate-data-streams/" class="btn btn-outline-primary" prompt="Newer"><p>Hiding In Alternate Data Streams</p></a></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/redteam/">redteam</a> <a class="post-tag" href="/tags/c2/">c2</a> <a class="post-tag" href="/tags/container/">container</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/graphana/">graphana</a> <a class="post-tag" href="/tags/jira/">jira</a> <a class="post-tag" href="/tags/nessus/">nessus</a> <a class="post-tag" href="/tags/non-technical/">non-technical</a> <a class="post-tag" href="/tags/nuages/">nuages</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2026 <a href="https://twitter.com/">Matt Culbert</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
